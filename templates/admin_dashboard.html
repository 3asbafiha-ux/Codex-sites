<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔥 S1X TEAM ADVANCED ADMIN PANEL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff41;
            font-family: 'Fira Code', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 2px solid #00ff41;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 255, 65, 0.3);
        }

        .header h1 {
            font-size: 24px;
            text-shadow: 0 0 20px #00ff41;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logout-btn {
            background: #ff0080;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Main Layout */
        .admin-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(0, 20, 0, 0.9);
            border-right: 1px solid #00ff41;
            padding: 20px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 0;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover, .nav-item.active {
            border-color: #00ff41;
            background: rgba(0, 255, 65, 0.1);
            transform: translateX(5px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #00ff41;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 65, 0.3);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #ff0080;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Control Panels */
        .control-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 20px;
            color: #ff0080;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #00ff41, #ff0080);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff0080, #ff4444);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffaa00, #ff6600);
        }

        .btn-info {
            background: linear-gradient(45deg, #00aaff, #0066ff);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.5);
        }

        .data-table th,
        .data-table td {
            border: 1px solid #333;
            padding: 10px;
            text-align: right;
            font-size: 12px;
        }

        .data-table th {
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: rgba(0, 255, 65, 0.05);
        }

        /* Status indicators */
        .status-active { color: #00ff41; }
        .status-inactive { color: #ff0080; }
        .status-maintenance { color: #ffaa00; }
        .status-blocked { color: #ff4444; }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            border-radius: 5px;
            color: #00ff41;
            font-family: inherit;
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff0080;
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #00ff41;
            border-radius: 10px;
            padding: 30px;
            min-width: 400px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: #ff0080;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }

        .alert-success {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid #00ff41;
            color: #00ff41;
        }

        .alert-error {
            background: rgba(255, 0, 128, 0.1);
            border: 1px solid #ff0080;
            color: #ff0080;
        }

        .alert-warning {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid #ffaa00;
            color: #ffaa00;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid #00ff41;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* New Styles for Advanced Features */
        .users-detailed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .user-detailed-card {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #00ff41;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s;
        }
        .user-detailed-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.3);
        }

        .enhanced-logs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
        }

        .log-card {
            border-left: 4px solid #ccc; /* Default color */
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .enhanced-blocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .block-card {
            border: 1px solid #ffaa00; /* Default color */
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.5);
        }

        /* User Secret Keys Styles */
        .keys-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin: 0;
            font-weight: bold;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .secret-key-display {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }

        .secret-key-display:hover {
            background: #e9ecef;
        }

        .key-id {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .verification-count {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .status-active {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-inactive {
            background: #9e9e9e;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .text-muted {
            color: #6c757d;
            font-size: 11px;
        }

    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>🔥 S1X TEAM ADVANCED ADMIN PANEL</h1>
        <div class="header-controls">
            <span id="admin-username">Loading...</span>
            <button class="logout-btn" onclick="logout()">🚪 Logout</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('dashboard')">
                📊 Dashboard
            </div>
            <div class="nav-item" onclick="showSection('users')">
                👥 User Management
            </div>
            <div class="nav-item" onclick="showSection('apis')">
                🔗 API Management
            </div>
            <div class="nav-item" onclick="showSection('visitors')">
                👁️ Visitor Tracking
            </div>
            <div class="nav-item" onclick="showSection('security')">
                🛡️ Security & Blocks
            </div>
            <div class="nav-item" onclick="showSection('maintenance')">
                🔧 Maintenance
            </div>
            <div class="nav-item" onclick="showSection('logs')">
                📋 Activity Logs
            </div>
            <div class="nav-item" onclick="showSection('config')">
                ⚙️ Configuration
            </div>
            <div class="nav-item" onclick="showSection('export')">
                📤 Export Data
            </div>
            <div class="nav-item" onclick="showSection('site-control')">
                🎛️ Site Control
            </div>
            <div class="nav-item" onclick="showSection('advanced-security')">
                🛡️ Advanced Security
            </div>
            <div class="nav-item" onclick="showSection('analytics')">
                📊 Advanced Analytics
            </div>
            <div class="nav-item" onclick="showSection('system-monitor')">
                💻 System Monitor
            </div>
            <!-- Super Admin Section -->
            <div class="nav-item" onclick="showSection('super-admin')">
                👑 Super Admin Panel
            </div>
            <!-- Enhanced Logs Section -->
            <div class="nav-item" onclick="showSection('enhanced-logs')">
                📜 Enhanced Logs
            </div>
            <!-- Block Manager Section -->
            <div class="nav-item" onclick="showSection('block-manager')">
                🚨 Block Manager
            </div>
            <!-- S1X Protection Section -->
            <div class="nav-item" onclick="showSection('s1x-protection')">
                🛡️ S1X Protection
            </div>
            <!-- User Secret Keys Section -->
            <div class="nav-item" onclick="showSection('user-keys')">
                🔑 User Secret Keys
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <h2>📊 System Overview</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-visitors">0</div>
                        <div class="stat-label">Total Visitors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-sessions">0</div>
                        <div class="stat-label">Active Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="blocked-ips">0</div>
                        <div class="stat-label">Blocked IPs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-apis">0</div>
                        <div class="stat-label">Total APIs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="maintenance-apis">0</div>
                        <div class="stat-label">Under Maintenance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-admins">0</div>
                        <div class="stat-label">Admin Users</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🎛️ Quick Actions</h3>
                    <button class="btn" onclick="refreshDashboard()">🔄 Refresh Data</button>
                    <button class="btn btn-info" onclick="viewSystemStatus()">📊 System Status</button>
                    <button class="btn btn-warning" onclick="performBackup()">💾 Backup Data</button>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="users" class="content-section">
                <h2>👥 User Management</h2>

                <div class="control-panel">
                    <h3 class="panel-title">➕ Create New Admin</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="new-username" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="new-password" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="new-role">
                                <option value="admin">Admin</option>
                                <option value="moderator">Moderator</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="createUser()">👤 Create User</button>
                    <button class="btn btn-info" onclick="generateToken()">🔑 Generate Token</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📋 Admin Users</h3>
                    <button class="btn" onclick="loadUsers()">🔄 Refresh Users</button>
                    <table class="data-table" id="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr><td colspan="5" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- API Management Section -->
            <div id="apis" class="content-section">
                <h2>🔗 API Management</h2>

                <div class="control-panel">
                    <h3 class="panel-title">🧪 API Testing</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select API</label>
                            <select id="test-api-select">
                                <option value="">Select API to test</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Test Parameters (JSON)</label>
                            <textarea id="test-params" rows="3" placeholder='{"param1": "value1"}'></textarea>
                        </div>
                    </div>
                    <button class="btn" onclick="testAPI()">🧪 Test API</button>
                    <div id="test-results"></div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">➕ Add New API</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>API Name</label>
                            <input type="text" id="new-api-name" placeholder="Enter API name">
                        </div>
                        <div class="form-group">
                            <label>API URL</label>
                            <input type="text" id="new-api-url" placeholder="Enter API URL with parameters">
                        </div>
                        <div class="form-group">
                            <label>Method</label>
                            <select id="new-api-method">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Timeout (seconds)</label>
                            <input type="number" id="new-api-timeout" value="30" min="5" max="120">
                        </div>
                    </div>
                    <button class="btn" onclick="addNewAPI()">➕ Add API</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📋 API Endpoints</h3>
                    <button class="btn" onclick="loadAPIs()">🔄 Refresh APIs</button>
                    <table class="data-table" id="apis-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Method</th>
                                <th>Timeout</th>
                                <th>Status</th>
                                <th>Maintenance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="apis-tbody">
                            <tr><td colspan="7" class="loading">Loading APIs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Visitor Tracking Section -->
            <div id="visitors" class="content-section">
                <h2>👁️ Visitor Tracking</h2>

                <div class="control-panel">
                    <h3 class="panel-title">📊 Visitor Statistics</h3>
                    <button class="btn" onclick="loadVisitors()">🔄 Refresh Visitors</button>
                    <button class="btn btn-warning" onclick="clearVisitorLogs()">🗑️ Clear Logs</button>

                    <table class="data-table" id="visitors-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Visit Count</th>
                                <th>First Visit</th>
                                <th>Last Visit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="visitors-tbody">
                            <tr><td colspan="6" class="loading">Loading visitors...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Security & Blocks Section -->
            <div id="security" class="content-section">
                <h2>🛡️ Security & IP Blocks</h2>

                <div class="control-panel">
                    <h3 class="panel-title">🚫 Add IP Block</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>IP Address</label>
                            <input type="text" id="block-ip" placeholder="192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="block-reason" placeholder="Reason for blocking">
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="block-duration" placeholder="60" value="60">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="block-permanent"> Permanent Block
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="addBlock()">🚫 Block IP</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📋 Blocked IPs</h3>
                    <button class="btn" onclick="loadBlocks()">🔄 Refresh Blocks</button>

                    <table class="data-table" id="blocks-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Reason</th>
                                <th>Blocked At</th>
                                <th>Type</th>
                                <th>Remaining Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="blocks-tbody">
                            <tr><td colspan="6" class="loading">Loading blocks...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Maintenance Section -->
            <div id="maintenance" class="content-section">
                <h2>🔧 Maintenance Mode</h2>

                <div class="control-panel">
                    <h3 class="panel-title">⚙️ Feature Maintenance</h3>
                    <p>Toggle maintenance mode for individual features. When enabled, users will see a maintenance message.</p>

                    <div id="maintenance-controls">
                        <div class="loading">Loading maintenance controls...</div>
                    </div>
                </div>
            </div>

            <!-- Activity Logs Section -->
            <div id="logs" class="content-section">
                <h2>📋 Activity Logs</h2>

                <div class="control-panel">
                    <h3 class="panel-title">📝 System Logs</h3>
                    <button class="btn" onclick="loadLogs()">🔄 Refresh Logs</button>
                    <button class="btn btn-warning" onclick="exportLogs()">📤 Export Logs</button>

                    <table class="data-table" id="logs-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>IP</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logs-tbody">
                            <tr><td colspan="5" class="loading">Loading logs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Configuration Section -->
            <div id="config" class="content-section">
                <h2>⚙️ System Configuration</h2>

                <div class="control-panel">
                    <h3 class="panel-title">🛠️ Site Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Site Name</label>
                            <input type="text" id="config-site-name">
                        </div>
                        <div class="form-group">
                            <label>Rate Limit (per minute)</label>
                            <input type="number" id="config-rate-minute">
                        </div>
                        <div class="form-group">
                            <label>Rate Limit (per hour)</label>
                            <input type="number" id="config-rate-hour">
                        </div>
                        <div class="form-group">
                            <label>Max Failed Attempts</label>
                            <input type="number" id="config-max-attempts">
                        </div>
                    </div>
                    <button class="btn" onclick="saveConfig()">💾 Save Configuration</button>
                    <button class="btn btn-info" onclick="loadConfig()">🔄 Reload Config</button>
                </div>
            </div>

            <!-- Export Data Section -->
            <div id="export" class="content-section">
                <h2>📤 Export Data</h2>

                <div class="control-panel">
                    <h3 class="panel-title">📊 Data Export</h3>
                    <p>Export system data for backup or analysis purposes.</p>

                    <div class="form-grid">
                        <button class="btn" onclick="exportData('config')">⚙️ Export Config</button>
                        <button class="btn" onclick="exportData('users')">👥 Export Users</button>
                        <button class="btn" onclick="exportData('apis')">🔗 Export APIs</button>
                        <button class="btn" onclick="exportData('visitors')">👁️ Export Visitors</button>
                        <button class="btn" onclick="exportData('blocks')">🚫 Export Blocks</button>
                        <button class="btn" onclick="exportData('logs')">📋 Export Logs</button>
                    </div>

                    <div class="form-grid" style="margin-top: 20px;">
                        <button class="btn btn-warning" onclick="createFullBackup()">💾 Full Backup</button>
                    </div>
                </div>
            </div>

            <!-- Site Control Section -->
            <div id="site-control" class="content-section">
                <h2>🎛️ Advanced Site Control</h2>

                <div class="control-panel">
                    <h3 class="panel-title">🚨 Emergency Controls</h3>
                    <div class="form-grid">
                        <button class="btn btn-danger" onclick="emergencyShutdown()">🛑 Emergency Shutdown</button>
                        <button class="btn btn-info" onclick="restoreSite()">✅ Restore Site</button>
                        <button class="btn btn-warning" onclick="restartSystem()">🔄 Restart System</button>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📢 Site Announcements</h3>
                    <div class="form-group">
                        <label>Announcement Message</label>
                        <textarea id="announcement-message" rows="3" placeholder="Enter announcement message..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="announcement-type">
                            <option value="info">Info (Blue)</option>
                            <option value="warning">Warning (Yellow)</option>
                            <option value="danger">Danger (Red)</option>
                            <option value="success">Success (Green)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createAnnouncement()">📢 Create Announcement</button>
                    <button class="btn btn-warning" onclick="toggleAnnouncement()">🔄 Toggle Announcement</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🎨 Site Theme Control</h3>
                    <div class="form-group">
                        <label>Select Theme</label>
                        <select id="site-theme">
                            <option value="default">Default (Dark)</option>
                            <option value="light">Light Theme</option>
                            <option value="blue">Blue Theme</option>
                            <option value="green">Green Theme</option>
                            <option value="red">Red Theme</option>
                        </select>
                    </div>
                    <button class="btn" onclick="changeSiteTheme()">🎨 Apply Theme</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🗑️ Database Management</h3>
                    <div class="form-grid">
                        <button class="btn btn-danger" onclick="clearDatabase('visitors')">🗑️ Clear Visitors</button>
                        <button class="btn btn-danger" onclick="clearDatabase('blocks')">🗑️ Clear Blocks</button>
                        <button class="btn btn-danger" onclick="clearDatabase('logs')">🗑️ Clear Logs</button>
                        <button class="btn btn-danger" onclick="clearDatabase('sessions')">🗑️ Clear Sessions</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Security Section -->
            <div id="advanced-security" class="content-section">
                <h2>🛡️ Advanced Security Controls</h2>

                <div class="control-panel">
                    <h3 class="panel-title">🚫 Mass IP Blocking</h3>
                    <div class="form-group">
                        <label>IP Addresses (one per line or comma separated)</label>
                        <textarea id="mass-block-ips" rows="5" placeholder="192.168.1.1&#10;192.168.1.2&#10;10.0.0.1"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Block Reason</label>
                        <input type="text" id="mass-block-reason" placeholder="Mass block reason..." value="Mass block by admin">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="mass-block-permanent"> Permanent Block
                        </label>
                    </div>
                    <button class="btn btn-danger" onclick="massBlockIPs()">🚫 Mass Block</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">✅ Whitelist Management</h3>
                    <div class="form-group">
                        <label>IP Address</label>
                        <input type="text" id="whitelist-ip" placeholder="192.168.1.1">
                    </div>
                    <div class="form-grid">
                        <button class="btn" onclick="manageWhitelist('add')">✅ Add to Whitelist</button>
                        <button class="btn btn-warning" onclick="manageWhitelist('remove')">❌ Remove from Whitelist</button>
                        <button class="btn btn-info" onclick="loadWhitelist()">📋 View Whitelist</button>
                    </div>
                    <div id="whitelist-display" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Advanced Analytics Section -->
            <div id="analytics" class="content-section">
                <h2>📊 Advanced Analytics</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="visitors-hour">0</div>
                        <div class="stat-label">Last Hour</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="visitors-day">0</div>
                        <div class="stat-label">Last 24 Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="visitors-week">0</div>
                        <div class="stat-label">Last Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="unique-ips">0</div>
                        <div class="stat-label">Unique IPs</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📈 Top Pages</h3>
                    <div id="top-endpoints-chart"></div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🌐 Browser Statistics</h3>
                    <div id="browser-stats-chart"></div>
                </div>

                <button class="btn" onclick="loadDetailedAnalytics()">🔄 Refresh Analytics</button>
            </div>

            <!-- System Monitor Section -->
            <div id="system-monitor" class="content-section">
                <h2>💻 System Performance Monitor</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="cpu-usage">0%</div>
                        <div class="stat-label">CPU Usage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="memory-usage">0%</div>
                        <div class="stat-label">Memory Usage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="disk-usage">0%</div>
                        <div class="stat-label">Disk Usage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="uptime">0</div>
                        <div class="stat-label">Uptime (hours)</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📊 System Details</h3>
                    <div id="system-details"></div>
                </div>

                <button class="btn" onclick="loadSystemPerformance()">🔄 Refresh Performance</button>
            </div>

            <!-- Super Admin Panel Section -->
            <div id="super-admin" class="content-section">
                <h2>👑 Super Admin Panel</h2>

                <div class="control-panel">
                    <h3 class="panel-title">📊 System Overview</h3>
                    <div id="system-overview">
                        <div class="loading">Loading system overview...</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🔥 Ultimate Super Admin Controls</h3>
                    <div class="form-grid">
                        <button class="btn btn-danger" onclick="showDeleteUserForm()">🗑️ Delete Admin User</button>
                        <button class="btn btn-warning" onclick="showForcePasswordReset()">🔐 Force Password Reset</button>
                        <button class="btn btn-info" onclick="showAccountTakeover()">👤 Take Over Account</button>
                        <button class="btn" onclick="showGrantSuperAdmin()">👑 Grant Super Admin</button>
                        <button class="btn btn-warning" onclick="showFeatureManager()">🎛️ Manage User Features</button>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🎛️ Admin Feature Control</h3>
                    <p>Hide or show specific features for individual admin users</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select Admin User</label>
                            <select id="feature-target-user">
                                <option value="">Select user to modify</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Available Features</label>
                            <div id="features-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #00ff41; padding: 10px; border-radius: 5px;">
                                <div class="loading">Loading features...</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid">
                        <button class="btn btn-warning" onclick="hideSelectedFeatures()">🚫 Hide Selected Features</button>
                        <button class="btn btn-info" onclick="showSelectedFeatures()">✅ Show Selected Features</button>
                        <button class="btn" onclick="loadUserFeatures()">🔄 Refresh Features</button>
                    </div>
                    <div id="current-user-features" style="margin-top: 15px;"></div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">👥 Manage All Users</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select User</label>
                            <select id="super-target-user">
                                <option value="">Select user to modify</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>New Password (optional)</label>
                            <input type="password" id="super-new-password" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label>New Token (optional)</label>
                            <input type="text" id="super-new-token" placeholder="Generate or paste new token">
                        </div>
                        <div class="form-group">
                            <label>New Role</label>
                            <select id="super-new-role">
                                <option value="">--Select Role--</option>
                                <option value="admin">Admin</option>
                                <option value="moderator">Moderator</option>
                                <option value="viewer">Viewer</option>
                                <option value="superadmin">Super Admin</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="superAdminModifyUser()">✏️ Modify User</button>
                    <button class="btn btn-info" onclick="generateSuperToken()">🔑 Generate Super Token</button>
                    <button class="btn" onclick="loadAllUsersInfo()">🔄 Refresh User List</button>
                    <div id="all-users-info" style="margin-top: 20px;">
                        <div class="loading">Loading user details...</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🚨 Emergency System Reset</h3>
                    <p>This action will wipe all data and reset the system to its initial state.</p>
                    <button class="btn btn-danger" onclick="emergencyResetSystem()">🔥 Full System Reset</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🚪 Force Logout All Users</h3>
                    <p>Logs out all currently active sessions.</p>
                    <button class="btn btn-warning" onclick="forceLogoutAllUsers()">💥 Force Logout All</button>
                </div>
            </div>

            <!-- Enhanced Logs Section -->
            <div id="enhanced-logs" class="content-section">
                <h2>📜 Enhanced Activity Logs</h2>

                <div class="control-panel">
                    <h3 class="panel-title">⚙️ Log Filtering</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Action Type</label>
                            <input type="text" id="log-filter-action" placeholder="e.g., user_login">
                        </div>
                        <div class="form-group">
                            <label>Risk Level</label>
                            <select id="log-filter-risk">
                                <option value="">All Levels</option>
                                <option value="CRITICAL">Critical</option>
                                <option value="HIGH">High</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="LOW">Low</option>
                                <option value="INFO">Info</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <select id="log-filter-user">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Timeframe</label>
                            <select id="log-filter-time">
                                <option value="all">All Time</option>
                                <option value="hour">Last Hour</option>
                                <option value="day">Last 24 Hours</option>
                                <option value="week">Last Week</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="applyLogFilters()">🔍 Apply Filters</button>
                    <button class="btn btn-info" onclick="clearLogFilters()">❌ Clear Filters</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📝 Log Entries</h3>
                    <div id="enhanced-logs-display">
                        <div class="loading">Loading logs...</div>
                    </div>
                </div>
            </div>

            <!-- S1X Protection Section -->
            <div id="s1x-protection" class="content-section">
                <h2>🛡️ S1X TEAM Advanced Protection System</h2>

                <div class="control-panel">
                    <h3 class="panel-title">📊 Protection Statistics</h3>
                    <div id="protection-stats" class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="protection-status">OFF</div>
                            <div class="stat-label">Protection Status</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="protection-mode">MEDIUM</div>
                            <div class="stat-label">Current Mode</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="verified-sessions">0</div>
                            <div class="stat-label">Verified Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="failed-challenges">0</div>
                            <div class="stat-label">Failed Challenges</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="suspicious-detected">0</div>
                            <div class="stat-label">Suspicious IPs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ddos-targets">0</div>
                            <div class="stat-label">DDoS Targets</div>
                        </div>
                    </div>
                    <button class="btn" onclick="loadProtectionStats()">🔄 Refresh Stats</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">⚙️ Protection Configuration</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Enable Protection</label>
                            <select id="protection-enabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Protection Mode</label>
                            <select id="protection-mode-select">
                                <option value="low">Low Security</option>
                                <option value="medium">Medium Security</option>
                                <option value="high">High Security</option>
                                <option value="maximum">Maximum Security</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Challenge Icon URL</label>
                            <input type="text" id="protection-icon" placeholder="/static/images/generated-icon.png">
                        </div>
                        <div class="form-group">
                            <label>Challenge Title</label>
                            <input type="text" id="protection-title" placeholder="🛡️ S1X TEAM Security Verification">
                        </div>
                        <div class="form-group">
                            <label>Challenge Subtitle</label>
                            <input type="text" id="protection-subtitle" placeholder="تحقق من أنك إنسان وليس روبوت">
                        </div>
                        <div class="form-group">
                            <label>Difficulty Level</label>
                            <select id="protection-difficulty">
                                <option value="easy">Easy (5 attempts)</option>
                                <option value="medium">Medium (3 attempts)</option>
                                <option value="hard">Hard (2 attempts)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Block Duration (minutes)</label>
                            <input type="number" id="protection-block-duration" value="15" min="1" max="1440">
                        </div>
                        <div class="form-group">
                            <label>DDoS Threshold (req/sec)</label>
                            <input type="number" id="protection-ddos-threshold" value="10" min="1" max="100">
                        </div>
                    </div>
                    <button class="btn" onclick="saveProtectionConfig()">💾 Save Configuration</button>
                    <button class="btn btn-info" onclick="loadProtectionConfig()">🔄 Load Current Config</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">🧹 Security Data Management</h3>
                    <div class="form-grid">
                        <button class="btn btn-warning" onclick="clearSecurityData('failed')">🗑️ Clear Failed Challenges</button>
                        <button class="btn btn-warning" onclick="clearSecurityData('sessions')">🗑️ Clear Verification Sessions</button>
                        <button class="btn btn-warning" onclick="clearSecurityData('suspicious')">🗑️ Clear Suspicious IPs</button>
                        <button class="btn btn-danger" onclick="clearSecurityData('all')">🔥 Clear All Security Data</button>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📋 Verified Sessions</h3>
                    <div id="verified-sessions-list">
                        <div class="loading">Loading verified sessions...</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">⚠️ Suspicious Activity</h3>
                    <div id="suspicious-activity-list">
                        <div class="loading">Loading suspicious activity...</div>
                    </div>
                </div>
            </div>

            <!-- Block Manager Section -->
            <div id="block-manager" class="content-section">
                <h2>🚨 IP Block Manager</h2>

                <div class="control-panel">
                    <h3 class="panel-title">🚫 Smart IP Blocking</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>IP Address</label>
                            <input type="text" id="smart-block-ip" placeholder="192.168.1.1">
                        </div>
                        <div class="form-group">
                            <label>Block Reason/Type</label>
                            <select id="smart-block-type">
                                <option value="Suspicious Activity">Suspicious Activity</option>
                                <option value="Spamming">Spamming</option>
                                <option value="Malicious Intent">Malicious Intent</option>
                                <option value="Abuse">Abuse</option>
                                <option value="Custom">Custom Reason</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="smart-block-duration" placeholder="60" value="60">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="smart-block-permanent"> Permanent Block
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="smartBlockIP()">🚫 Block IP</button>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📊 Block Statistics</h3>
                    <div id="block-statistics">
                        <div class="loading">Loading statistics...</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3 class="panel-title">📋 Blocked IP List</h3>
                    <button class="btn" onclick="loadEnhancedBlockList()">🔄 Refresh List</button>
                    <div id="enhanced-block-list">
                        <div class="loading">Loading blocked IPs...</div>
                    </div>
                </div>
            </div>

            <!-- User Secret Keys Section -->
            <div id="user-keys" class="content-section">
                <h2>🔑 USER KEYS - إدارة المفاتيح السرية</h2>
                <div class="section-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: white; font-size: 16px; margin: 0 0 15px 0;">إدارة المفاتيح السرية للمستخدمين المتحققين من نظام S1X TEAM الأمني</p>
                    <div class="action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="refreshUserKeys()" class="btn" style="background: #4CAF50;">🔄 تحديث البيانات</button>
                        <button onclick="exportUserKeys()" class="btn btn-info">📤 تصدير المفاتيح</button>
                        <button onclick="showKeyStatistics()" class="btn" style="background: #2196F3;">📊 إحصائيات مفصلة</button>
                        <button onclick="clearAllUserKeys()" class="btn btn-danger">🗑️ مسح جميع المفاتيح</button>
                    </div>
                </div>

                <div class="keys-stats">
                    <div class="stat-card">
                        <h3 id="total-keys-count">0</h3>
                        <p>Total Users with Keys</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="active-sessions-count">0</h3>
                        <p>Active Sessions</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="keys-today-count">0</h3>
                        <p>Keys Created Today</p>
                    </div>
                </div>

                <div id="keys-advanced-stats">
                    <!-- Advanced statistics will be loaded here -->
                </div>

                <div class="table-container">
                    <table id="user-keys-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Secret Key</th>
                                <th>Key ID</th>
                                <th>Created</th>
                                <th>Verifications</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-keys-tbody">
                            <tr>
                                <td colspan="7" class="loading">Loading keys...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="close-modal" onclick="closeModal()">✕</button>
            </div>
            <div id="modal-body">
                Modal content goes here
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const sessionToken = sessionStorage.getItem('admin_session') || 
                           new URLSearchParams(window.location.search).get('session');
        
        // Store session token if received from URL parameter
        const urlSession = new URLSearchParams(window.location.search).get('session');
        if (urlSession && urlSession !== 'undefined') {
            sessionStorage.setItem('admin_session', urlSession);
        }

        if (!sessionToken) {
            alert('Invalid session - redirecting to login');
            window.location.href = '/admin/login';
        }

        // Helper to format datetime
        function formatDateTime(datetimeString) {
            if (!datetimeString) return 'N/A';
            const date = new Date(datetimeString);
            return date.toLocaleString('ar-EG', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // API Helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'X-Admin-Session': sessionToken,
                        'Content-Type': 'application/json'
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(endpoint, options);
                const result = await response.json();

                if (response.status === 401) {
                    alert('Session expired - please login again');
                    window.location.href = '/admin/login';
                    return null;
                }

                return result;
            } catch (error) {
                console.error('API Error:', error);
                showAlert('Connection error: ' + error.message, 'error');
                return null;
            }
        }

        // UI Helper Functions
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Show selected section and activate nav button
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            const targetNav = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
            if (targetNav) {
                targetNav.classList.add('active');
            }

            // Load section-specific data
            loadSectionData(sectionName);
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    refreshDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'apis':
                    loadAPIs();
                    break;
                case 'visitors':
                    loadVisitors();
                    break;
                case 'security':
                    loadBlocks();
                    break;
                case 'maintenance':
                    loadMaintenanceControls();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'config':
                    loadConfig();
                    break;
                case 'analytics':
                    loadDetailedAnalytics();
                    break;
                case 'system-monitor':
                    loadSystemPerformance();
                    break;
                case 'advanced-security':
                    loadWhitelist();
                    break;
                case 'super-admin':
                    loadAllUsersInfo();
                    loadSystemOverview();
                    break;
                case 'enhanced-logs':
                    loadLogs();
                    // تحميل أسماء المستخدمين في الفلتر
                    loadUsers().then(() => { // Assuming loadUsers populates a global ADMIN_USERS or similar
                        const userSelect = document.getElementById('log-filter-user');
                        if (userSelect) {
                            // Clear existing options except 'All Users'
                            userSelect.innerHTML = '<option value="">All Users</option>';
                            // Populate with loaded users (assuming users are loaded into a structure accessible here)
                            // This part might need adjustment based on how loadUsers actually stores user data
                            // For now, assuming loadUsers will populate the select directly or a global variable
                        }
                    });
                    break;
                case 'block-manager':
                    loadEnhancedBlockList();
                    break;
                case 'codex-protection':
                    loadProtectionStats();
                    loadProtectionConfig();
                    break;
                case 'user-keys':
                    loadUserSecretKeys();
                    break;
            }
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(alertDiv, mainContent.firstChild);
            } else {
                document.body.insertBefore(alertDiv, document.body.firstChild);
            }

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showModal(title, content) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modal = document.getElementById('modal');

            if (modalTitle) modalTitle.textContent = title;
            if (modalBody) modalBody.innerHTML = content;
            if (modal) modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.style.display = 'none';
        }

        // Dashboard Functions
        async function refreshDashboard() {
            const stats = await apiCall('/admin/api/stats');
            if (stats && stats.success) {
                document.getElementById('total-visitors').textContent = stats.data.total_visitors;
                document.getElementById('active-sessions').textContent = stats.data.active_sessions;
                document.getElementById('blocked-ips').textContent = stats.data.blocked_ips;
                document.getElementById('total-apis').textContent = stats.data.total_apis;
                document.getElementById('maintenance-apis').textContent = stats.data.maintenance_apis;
                document.getElementById('total-admins').textContent = stats.data.total_admins;
            }
        }

        // User Management Functions
        async function loadUsers() {
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                const tbody = document.getElementById('users-tbody');
                if (!tbody) return; // Guard clause
                tbody.innerHTML = '';

                users.data.forEach(user => {
                    const row = tbody.insertRow();
                    const statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
                    const lastLogin = user.last_login ? new Date(user.last_login * 1000).toLocaleString('ar-EG') : 'Never';

                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td class="${statusClass}">${user.status}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <button class="btn btn-warning" onclick="toggleUserStatus('${user.username}')">
                                ${user.status === 'active' ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-info" onclick="regenerateToken('${user.username}')">🔑 New Token</button>
                            <button class="btn btn-danger" onclick="deleteAdminUser('${user.username}')">🗑️ Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function createUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const role = document.getElementById('new-role').value;

            if (!username || !password) {
                showAlert('Username and password are required', 'error');
                return;
            }

            const result = await apiCall('/admin/api/users/create', 'POST', {
                username: username,
                password: password,
                role: role,
                permissions: ['read', 'write']
            });

            if (result && result.success) {
                showAlert('User created successfully! Token: ' + result.token, 'success');
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                loadUsers();
            }
        }

        async function toggleUserStatus(username) {
            const result = await apiCall(`/admin/api/users/${username}/toggle`, 'POST');
            if (result && result.success) {
                showAlert(result.message, 'success');
                loadUsers();
            }
        }

        async function regenerateToken(username) {
            if (confirm(`Regenerate token for ${username}? This will invalidate the current token.`)) {
                const result = await apiCall(`/admin/api/users/${username}/regenerate-token`, 'POST');
                if (result && result.success) {
                    showModal('New Token Generated', `
                        <p>New token for <strong>${username}</strong>:</p>
                        <textarea readonly style="width: 100%; height: 60px; margin: 10px 0;">${result.new_token}</textarea>
                        <p style="color: #ff0080;">⚠️ Save this token securely. It won't be shown again.</p>
                    `);
                }
            }
        }

        async function generateToken() {
            const token = 'CODEX_' + Math.random().toString(36).substr(2, 16) + '_' + Date.now();

            // Show token under password field
            const passwordField = document.getElementById('new-password');
            let tokenDisplay = document.getElementById('token-display');

            if (!tokenDisplay) {
                tokenDisplay = document.createElement('div');
                tokenDisplay.id = 'token-display';
                tokenDisplay.style.cssText = `
                    margin-top: 10px;
                    padding: 10px;
                    background: rgba(0,255,65,0.1);
                    border: 1px solid #00ff41;
                    border-radius: 5px;
                `;
                passwordField.parentElement.appendChild(tokenDisplay);
            }

            tokenDisplay.innerHTML = `
                <div style="color: #9932cc; font-size: 12px; margin-bottom: 5px;">Generated Token:</div>
                <div style="color: #00ff41; font-family: 'Fira Code', monospace; font-size: 11px; word-break: break-all;">${token}</div>
                <div style="color: #666; font-size: 10px; margin-top: 5px;">Copy this token for the new user</div>
            `;

            // Auto-fill password field with token
            passwordField.value = token;

            showAlert('Token generated and filled in password field', 'success');
        }

        // API Management Functions
        async function loadAPIs() {
            const apis = await apiCall('/admin/api/endpoints');
            if (apis && apis.success) {
                const tbody = document.getElementById('apis-tbody');
                if (!tbody) return; // Guard clause
                tbody.innerHTML = '';

                const select = document.getElementById('test-api-select');
                select.innerHTML = '<option value="">Select API to test</option>';

                apis.data.forEach(api => {
                    const row = tbody.insertRow();
                    const statusClass = api.status === 'active' ? 'status-active' : 'status-inactive';
                    const maintenanceClass = api.maintenance ? 'status-maintenance' : 'status-active';

                    row.innerHTML = `
                        <td>${api.name}</td>
                        <td style="font-size: 10px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${api.url}">${api.url.substring(0, 40)}...</td>
                        <td>${api.method}</td>
                        <td>${api.timeout}s</td>
                        <td class="${statusClass}">${api.status}</td>
                        <td class="${maintenanceClass}">${api.maintenance ? '🔧 Yes' : '✅ No'}</td>
                        <td>
                            <button class="btn btn-info" onclick="testSingleAPI('${api.name}')" title="Test API">🧪</button>
                            <button class="btn" onclick="editAPI('${api.name}')" title="Edit API">✏️</button>
                            <button class="btn btn-warning" onclick="duplicateAPI('${api.name}')" title="Duplicate API">📋</button>
                            <button class="btn btn-warning" onclick="toggleMaintenance('${api.name}', ${!api.maintenance})" title="${api.maintenance ? 'Enable' : 'Maintain'}">
                                ${api.maintenance ? '✅' : '🔧'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteAPI('${api.name}')" title="Delete API">🗑️</button>
                        </td>
                    `;

                    // Add to test select
                    const option = document.createElement('option');
                    option.value = api.name;
                    option.textContent = api.name;
                    select.appendChild(option);
                });
            }
        }

        async function testAPI() {
            const apiName = document.getElementById('test-api-select').value;
            const paramsText = document.getElementById('test-params').value.trim();

            if (!apiName) {
                showAlert('Please select an API to test', 'error');
                return;
            }

            let params = {};
            if (paramsText) {
                try {
                    params = JSON.parse(paramsText);
                } catch (e) {
                    showAlert('Invalid JSON in parameters', 'error');
                    return;
                }
            }

            const result = await apiCall(`/admin/api/endpoints/${apiName}/test`, 'POST', { params });
            if (result) {
                const resultDiv = document.getElementById('test-results');
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4>✅ Test Successful</h4>
                            <p><strong>Status:</strong> ${result.data.status_code}</p>
                            <p><strong>Response Time:</strong> ${result.data.response_time}s</p>
                            <p><strong>Response Size:</strong> ${result.data.response_size} bytes</p>
                            <details>
                                <summary>Response Content</summary>
                                <pre style="background: rgba(0,0,0,0.5); padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 10px;">${result.data.content}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <h4>❌ Test Failed</h4>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            }
        }

        async function testSingleAPI(apiName) {
            document.getElementById('test-api-select').value = apiName;
            await testAPI();
        }

        async function addNewAPI() {
            const name = document.getElementById('new-api-name').value.trim();
            const url = document.getElementById('new-api-url').value.trim();
            const method = document.getElementById('new-api-method').value;
            const timeout = parseInt(document.getElementById('new-api-timeout').value);

            if (!name || !url) {
                showAlert('API name and URL are required', 'error');
                return;
            }

            const result = await apiCall('/admin/api/endpoints/add', 'POST', {
                name: name,
                url: url,
                method: method,
                timeout: timeout,
                status: 'active',
                maintenance: false
            });

            if (result && result.success) {
                showAlert('API added successfully!', 'success');
                // Clear form
                document.getElementById('new-api-name').value = '';
                document.getElementById('new-api-url').value = '';
                document.getElementById('new-api-timeout').value = '30';
                loadAPIs();
            }
        }

        async function editAPI(apiName) {
            // إظهار نموذج تعديل API
            const apis = await apiCall('/admin/api/endpoints');
            if (!apis || !apis.success) return;

            const apiData = apis.data.find(api => api.name === apiName);
            if (!apiData) {
                showAlert('API not found', 'error');
                return;
            }

            const modalContent = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Name</label>
                        <input type="text" id="edit-api-name" value="${apiData.name}" readonly style="background: rgba(100,100,100,0.3);">
                    </div>
                    <div class="form-group">
                        <label>API URL</label>
                        <input type="text" id="edit-api-url" value="${apiData.url}">
                    </div>
                    <div class="form-group">
                        <label>Method</label>
                        <select id="edit-api-method">
                            <option value="GET" ${apiData.method === 'GET' ? 'selected' : ''}>GET</option>
                            <option value="POST" ${apiData.method === 'POST' ? 'selected' : ''}>POST</option>
                            <option value="PUT" ${apiData.method === 'PUT' ? 'selected' : ''}>PUT</option>
                            <option value="DELETE" ${apiData.method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Timeout (seconds)</label>
                        <input type="number" id="edit-api-timeout" value="${apiData.timeout}" min="5" max="120">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="edit-api-status">
                            <option value="active" ${apiData.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="inactive" ${apiData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="saveAPIChanges('${apiName}')">💾 Save Changes</button>
                    <button class="btn btn-warning" onclick="closeModal()" style="margin-left: 10px;">❌ Cancel</button>
                </div>
            `;

            showModal(`🔧 Edit API: ${apiName}`, modalContent);
        }

        async function saveAPIChanges(originalName) {
            const name = document.getElementById('edit-api-name').value.trim();
            const url = document.getElementById('edit-api-url').value.trim();
            const method = document.getElementById('edit-api-method').value;
            const timeout = parseInt(document.getElementById('edit-api-timeout').value);
            const status = document.getElementById('edit-api-status').value;

            if (!url) {
                showAlert('API URL is required', 'error');
                return;
            }

            const result = await apiCall(`/admin/api/endpoints/${originalName}/update`, 'POST', {
                url: url,
                method: method,
                timeout: timeout,
                status: status
            });

            if (result && result.success) {
                showAlert('API updated successfully!', 'success');
                closeModal();
                loadAPIs();
            }
        }

        async function deleteAPI(apiName) {
            if (!confirm(`هل أنت متأكد من حذف API "${apiName}"؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                return;
            }

            const result = await apiCall(`/admin/api/endpoints/${apiName}/delete`, 'DELETE');

            if (result && result.success) {
                showAlert('API deleted successfully!', 'success');
                loadAPIs();
            }
        }

        async function duplicateAPI(apiName) {
            const apis = await apiCall('/admin/api/endpoints');
            if (!apis || !apis.success) return;

            const apiData = apis.data.find(api => api.name === apiName);
            if (!apiData) {
                showAlert('API not found', 'error');
                return;
            }

            // إنشاء نسخة جديدة بإضافة _copy للاسم
            let newName = apiData.name + '_copy';
            let counter = 1;
            
            // التأكد من أن الاسم الجديد غير موجود
            while (apis.data.some(api => api.name === newName)) {
                newName = apiData.name + '_copy' + counter;
                counter++;
            }

            const result = await apiCall('/admin/api/endpoints/add', 'POST', {
                name: newName,
                url: apiData.url,
                method: apiData.method,
                timeout: apiData.timeout,
                status: 'inactive', // بداية غير نشط للأمان
                maintenance: false
            });

            if (result && result.success) {
                showAlert(`API duplicated as "${newName}"`, 'success');
                loadAPIs();
            }
        }

        async function toggleMaintenance(apiName, enable) {
            let reason = 'Scheduled maintenance';
            let estimatedTime = 'Unknown';

            if (enable) {
                reason = prompt('Maintenance reason:', 'Scheduled maintenance') || reason;
                estimatedTime = prompt('Estimated completion time:', 'Unknown') || estimatedTime;
            }

            const result = await apiCall(`/admin/api/endpoints/${apiName}/maintenance`, 'POST', {
                enabled: enable,
                reason: reason,
                estimated_time: estimatedTime
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                loadAPIs();
            }
        }

        // Visitor Management Functions
        async function loadVisitors() {
            const visitors = await apiCall('/admin/api/visitors');
            if (visitors && visitors.success) {
                const tbody = document.getElementById('visitors-tbody');
                if (!tbody) return; // Guard clause
                tbody.innerHTML = '';

                visitors.data.forEach(visitor => {
                    const row = tbody.insertRow();
                    const statusClass = visitor.blocked ? 'status-blocked' : 'status-active';

                    row.innerHTML = `
                        <td>${visitor.ip}</td>
                        <td>${visitor.visit_count}</td>
                        <td>${visitor.first_visit_datetime}</td>
                        <td>${visitor.last_visit_datetime}</td>
                        <td class="${statusClass}">${visitor.blocked ? 'Blocked' : 'Active'}</td>
                        <td>
                            ${!visitor.blocked ? 
                                `<button class="btn btn-danger" onclick="quickBlockIP('${visitor.ip}')">🚫 Block</button>` :
                                `<button class="btn btn-info" onclick="unblockIP('${visitor.ip}')">✅ Unblock</button>`
                            }
                        </td>
                    `;
                });
            }
        }

        async function clearVisitorLogs() {
            if (confirm('⚠️ This will permanently delete all visitor logs! Continue?')) {
                const result = await apiCall('/admin/api/database/clear', 'POST', { type: 'visitors' });
                if (result && result.success) {
                    showAlert(result.message, 'warning');
                    refreshDashboard();
                    loadVisitors();
                }
            }
        }

        async function quickBlockIP(ip) {
            const reason = prompt(`Block reason for ${ip}:`, 'Suspicious activity') || 'Blocked by admin';
            const result = await apiCall('/admin/api/blocks/add', 'POST', {
                ip: ip,
                reason: reason,
                duration: 60,
                permanent: false
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                loadVisitors();
                loadBlocks();
            }
        }

        // Security Functions
        async function loadBlocks() {
            const blocks = await apiCall('/admin/api/blocks');
            if (blocks && blocks.success) {
                const tbody = document.getElementById('blocks-tbody');
                if (!tbody) return; // Guard clause
                tbody.innerHTML = '';

                blocks.data.forEach(block => {
                    const row = tbody.insertRow();
                    const type = block.permanent ? 'Permanent' : 'Temporary';
                    const remaining = block.remaining_seconds ? Math.round(block.remaining_seconds / 60) + ' min' : 'N/A';

                    row.innerHTML = `
                        <td>${block.ip}</td>
                        <td>${block.reason}</td>
                        <td>${block.blocked_datetime}</td>
                        <td>${type}</td>
                        <td>${remaining}</td>
                        <td>
                            <button class="btn btn-info" onclick="unblockIP('${block.ip}')">✅ Unblock</button>
                        </td>
                    `;
                });
            }
        }

        async function addBlock() {
            const ip = document.getElementById('block-ip').value.trim();
            const reason = document.getElementById('block-reason').value.trim();
            const duration = parseInt(document.getElementById('block-duration').value);
            const permanent = document.getElementById('block-permanent').checked;

            if (!ip || !reason) {
                showAlert('IP address and reason are required', 'error');
                return;
            }

            const result = await apiCall('/admin/api/blocks/add', 'POST', {
                ip: ip,
                reason: reason,
                duration: duration,
                permanent: permanent
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                // Clear form
                document.getElementById('block-ip').value = '';
                document.getElementById('block-reason').value = '';
                document.getElementById('block-duration').value = '60';
                document.getElementById('block-permanent').checked = false;
                loadBlocks();
            }
        }

        async function unblockIP(ip) {
            if (confirm(`Unblock IP ${ip}?`)) {
                const result = await apiCall(`/admin/api/blocks/${ip}/remove`, 'POST');
                if (result && result.success) {
                    showAlert(result.message, 'success');
                    loadBlocks();
                    loadVisitors();
                    loadEnhancedBlockList(); // Also update the manager list
                }
            }
        }

        // Maintenance Functions
        async function loadMaintenanceControls() {
            const apis = await apiCall('/admin/api/endpoints');
            if (apis && apis.success) {
                const container = document.getElementById('maintenance-controls');
                if (!container) return; // Guard clause
                container.innerHTML = '';

                apis.data.forEach(api => {
                    const controlDiv = document.createElement('div');
                    controlDiv.style.cssText = 'border: 1px solid #333; padding: 15px; margin: 10px 0; border-radius: 8px;';

                    const statusIcon = api.maintenance ? '🔧' : '✅';
                    const statusText = api.maintenance ? 'Under Maintenance' : 'Active';
                    const statusClass = api.maintenance ? 'status-maintenance' : 'status-active';

                    controlDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4>${statusIcon} ${api.name}</h4>
                                <p class="${statusClass}">${statusText}</p>
                                ${api.maintenance ? `<small>Reason: ${api.reason || 'N/A'}</small>` : ''}
                            </div>
                            <button class="btn ${api.maintenance ? 'btn-info' : 'btn-warning'}" 
                                    onclick="toggleMaintenance('${api.name}', ${!api.maintenance})">
                                ${api.maintenance ? '✅ Enable' : '🔧 Maintain'}
                            </button>
                        </div>
                    `;

                    container.appendChild(controlDiv);
                });
            }
        }

        // Logs Functions
        async function loadLogs() {
            const logs = await apiCall('/admin/api/logs');
            if (logs && logs.success) {
                const tbody = document.getElementById('logs-tbody');
                if (!tbody) return; // Guard clause
                tbody.innerHTML = '';

                logs.data.forEach(log => {
                    const row = tbody.insertRow();
                    // Displaying a truncated version of details for the table view
                    const details = typeof log.details === 'object' ? JSON.stringify(log.details) : log.details;
                    const displayDetails = details ? details.substring(0, 100) + (details.length > 100 ? '...' : '') : 'N/A';

                    row.innerHTML = `
                        <td>${log.datetime}</td>
                        <td>${log.action}</td>
                        <td>${log.user || 'System'}</td>
                        <td>${log.ip}</td>
                        <td style="font-size: 10px;">${displayDetails}</td>
                    `;
                });
            }
        }

        async function exportLogs() {
            try {
                showAlert('جاري تصدير السجلات...', 'warning');

                const result = await apiCall('/admin/api/export/logs');

                if (result && result.success && result.data) {
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `logs_export_${timestamp}.json`;

                    const jsonData = JSON.stringify(result.data, null, 2);

                    const blob = new Blob([jsonData], {
                        type: 'application/json;charset=utf-8'
                    });

                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(url);

                    showAlert('تم تصدير السجلات بنجاح!', 'success');

                } else {
                    const errorMessage = result?.message || 'فشل في تصدير السجلات';
                    showAlert(`خطأ: ${errorMessage}`, 'error');
                }

            } catch (error) {
                console.error('Export logs error:', error);
                showAlert(`خطأ في تصدير السجلات: ${error.message}`, 'error');
            }
        }

        // Configuration Functions
        async function loadConfig() {
            const config = await apiCall('/admin/api/config');
            if (config && config.success) {
                document.getElementById('config-site-name').value = config.data.site_name || '';
                document.getElementById('config-rate-minute').value = config.data.rate_limits?.per_minute || 30;
                document.getElementById('config-rate-hour').value = config.data.rate_limits?.per_hour || 200;
                document.getElementById('config-max-attempts').value = config.data.security?.max_failed_attempts || 5;
            }
        }

        async function saveConfig() {
            const configData = {
                site_name: document.getElementById('config-site-name').value,
                rate_limits: {
                    per_minute: parseInt(document.getElementById('config-rate-minute').value),
                    per_hour: parseInt(document.getElementById('config-rate-hour').value)
                },
                security: {
                    max_failed_attempts: parseInt(document.getElementById('config-max-attempts').value)
                }
            };

            const result = await apiCall('/admin/api/config/update', 'POST', configData);
            if (result && result.success) {
                showAlert('Configuration saved successfully', 'success');
            }
        }

        // Export Functions
        async function exportData(dataType) {
            try {
                showAlert(`جاري تصدير ${dataType}...`, 'warning');

                const result = await apiCall(`/admin/api/export/${dataType}`);

                if (result && result.success && result.data) {
                    // التأكد من وجود البيانات
                    const exportData = result.data;
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `${dataType}_export_${timestamp}.json`;

                    // تحويل البيانات إلى JSON
                    const jsonData = JSON.stringify(exportData, null, 2);

                    // إنشاء الملف وتحميله
                    const blob = new Blob([jsonData], {
                        type: 'application/json;charset=utf-8'
                    });

                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';

                    // إضافة الرابط إلى الصفحة وتحميل الملف
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // تنظيف الذاكرة
                    URL.revokeObjectURL(url);

                    showAlert(`تم تصدير ${dataType} بنجاح!`, 'success');

                } else if (result && !result.success) {
                    // التعامل مع أخطاء الخادم
                    const errorMessage = result.message || result.error || 'فشل في تصدير البيانات';
                    showAlert(`خطأ في التصدير: ${errorMessage}`, 'error');

                } else {
                    // التعامل مع البيانات المفقودة
                    showAlert(`لا توجد بيانات لتصدير ${dataType}`, 'warning');
                }

            } catch (error) {
                console.error('Export error:', error);
                showAlert(`خطأ في التصدير: ${error.message}`, 'error');
            }
        }

        // Utility Functions
        async function performBackup() {
            try {
                showAlert('جاري إنشاء نسخة احتياطية كاملة...', 'warning');

                const backupData = {};
                const exportTypes = ['config', 'users', 'apis', 'visitors', 'blocks', 'logs'];
                let successCount = 0;

                for (const type of exportTypes) {
                    try {
                        const result = await apiCall(`/admin/api/export/${type}`);
                        if (result && result.success && result.data) {
                            backupData[type] = result.data;
                            successCount++;
                        } else {
                            console.warn(`فشل في تصدير ${type}:`, result);
                            backupData[type] = null; // حفظ null بدلاً من تجاهل النوع
                        }
                    } catch (error) {
                        console.error(`خطأ في تصدير ${type}:`, error);
                        backupData[type] = null;
                    }
                }

                if (successCount > 0) {
                    // إضافة معلومات النسخة الاحتياطية
                    backupData._backup_info = {
                        created_at: new Date().toISOString(),
                        total_types: exportTypes.length,
                        successful_exports: successCount,
                        failed_exports: exportTypes.length - successCount,
                        version: '1.0'
                    };

                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `full_backup_${timestamp}.json`;

                    const jsonData = JSON.stringify(backupData, null, 2);

                    const blob = new Blob([jsonData], {
                        type: 'application/json;charset=utf-8'
                    });

                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(url);

                    showAlert(`تمت النسخة الاحتياطية بنجاح! (${successCount}/${exportTypes.length} أنواع)`, 'success');
                } else {
                    showAlert('فشل في إنشاء النسخة الاحتياطية - لا توجد بيانات للتصدير', 'error');
                }

            } catch (error) {
                console.error('Backup error:', error);
                showAlert(`خطأ في إنشاء النسخة الاحتياطية: ${error.message}`, 'error');
            }
        }

        function logout() {
            sessionStorage.removeItem('admin_session');
            window.location.href = '/admin/login';
        }

        // Advanced Site Control Functions
        async function emergencyShutdown() {
            if (confirm('⚠️ This will shut down the entire site! Continue?')) {
                const reason = prompt('Shutdown reason:', 'Emergency maintenance') || 'Emergency maintenance';
                const result = await apiCall('/admin/api/site-control/shutdown', 'POST', { reason });
                if (result && result.success) {
                    showAlert(result.message, 'warning');
                }
            }
        }

        async function restoreSite() {
            if (confirm('Restore site from emergency shutdown?')) {
                const result = await apiCall('/admin/api/site-control/restore', 'POST');
                if (result && result.success) {
                    showAlert(result.message, 'success');
                }
            }
        }

        async function restartSystem() {
            if (confirm('⚠️ This will restart the entire system! Continue?')) {
                const result = await apiCall('/admin/api/system/restart', 'POST');
                if (result && result.success) {
                    showAlert(result.message, 'warning');
                    setTimeout(() => location.reload(), 5000);
                }
            }
        }

        async function createAnnouncement() {
            const message = document.getElementById('announcement-message').value.trim();
            const type = document.getElementById('announcement-type').value;

            if (!message) {
                showAlert('Please enter announcement message', 'error');
                return;
            }

            const result = await apiCall('/admin/api/site-control/announcement', 'POST', {
                message: message,
                type: type
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                document.getElementById('announcement-message').value = '';
            }
        }

        async function toggleAnnouncement() {
            const result = await apiCall('/admin/api/site-control/announcement/toggle', 'POST');
            if (result && result.success) {
                showAlert(result.message, 'success');
            }
        }

        async function changeSiteTheme() {
            const theme = document.getElementById('site-theme').value;
            const result = await apiCall('/admin/api/site-control/theme', 'POST', { theme });
            if (result && result.success) {
                showAlert(result.message, 'success');
            }
        }

        async function clearDatabase(type) {
            if (confirm(`⚠️ This will permanently delete all ${type}! Continue?`)) {
                const result = await apiCall('/admin/api/database/clear', 'POST', { type });
                if (result && result.success) {
                    showAlert(result.message, 'warning');
                    refreshDashboard();
                }
            }
        }

        // Advanced Security Functions
        async function massBlockIPs() {
            const ips = document.getElementById('mass-block-ips').value.trim();
            const reason = document.getElementById('mass-block-reason').value.trim();
            const permanent = document.getElementById('mass-block-permanent').checked;

            if (!ips) {
                showAlert('Please enter IP addresses to block', 'error');
                return;
            }

            if (confirm('⚠️ This will block multiple IPs! Continue?')) {
                const result = await apiCall('/admin/api/security/mass-block', 'POST', {
                    ips: ips,
                    reason: reason,
                    permanent: permanent
                });

                if (result && result.success) {
                    showAlert(result.message, 'success');
                    document.getElementById('mass-block-ips').value = '';
                    loadBlocks();
                }
            }
        }

        async function manageWhitelist(action) {
            const ip = document.getElementById('whitelist-ip').value.trim();

            if (action !== 'list' && !ip) {
                showAlert('Please enter IP address', 'error');
                return;
            }

            const result = await apiCall('/admin/api/security/whitelist', 'POST', {
                action: action,
                ip: ip
            });

            if (result && result.success) {
                if (action === 'list') {
                    displayWhitelist(result.data);
                } else {
                    showAlert(result.message, 'success');
                    document.getElementById('whitelist-ip').value = '';
                    loadWhitelist();
                }
            }
        }

        async function loadWhitelist() {
            const result = await apiCall('/admin/api/security/whitelist', 'POST', { action: 'list' });
            if (result && result.success) {
                displayWhitelist(result.data);
            }
        }

        function displayWhitelist(whitelist) {
            const container = document.getElementById('whitelist-display');
            if (!container) return; // Guard clause
            if (whitelist.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">No IPs in whitelist</p>';
                return;
            }

            container.innerHTML = '<h4>Whitelist IPs:</h4><ul>' + 
                whitelist.map(ip => `<li>${ip}</li>`).join('') + 
                '</ul>';
        }

        // Advanced Analytics Functions
        async function loadDetailedAnalytics() {
            const analytics = await apiCall('/admin/api/analytics/detailed');
            if (analytics && analytics.success) {
                const data = analytics.data;

                document.getElementById('visitors-hour').textContent = data.time_stats.last_hour;
                document.getElementById('visitors-day').textContent = data.time_stats.last_day;
                document.getElementById('visitors-week').textContent = data.time_stats.last_week;
                document.getElementById('unique-ips').textContent = data.total_unique_ips;

                // Display top endpoints
                const endpointsHtml = data.top_endpoints.map(([endpoint, count]) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333;">
                        <span>${endpoint}</span><span>${count} visits</span>
                    </div>`
                ).join('');
                document.getElementById('top-endpoints-chart').innerHTML = endpointsHtml;

                // Display browser stats
                const browserHtml = Object.entries(data.browser_stats).map(([browser, count]) => 
                    `<div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333;">
                        <span>${browser}</span><span>${count} users</span>
                    </div>`
                ).join('');
                document.getElementById('browser-stats-chart').innerHTML = browserHtml;
            }
        }

        // System Performance Functions
        async function loadSystemPerformance() {
            try {
                const response = await fetch('/admin/api/system/performance', {
                    headers: {'X-Admin-Session': sessionToken}
                });

                if (response.ok) {
                    const result = await response.json();
                    displaySystemPerformance(result.data);
                } else {
                    document.getElementById('system-performance-data').innerHTML = 'Performance data unavailable';
                }
            } catch (error) {
                document.getElementById('system-performance-data').innerHTML = 'Error loading performance data';
            }
        }

        function displaySystemPerformance(data) {
            if (!data) return;

            if (data.cpu_usage !== 'N/A') {
                document.getElementById('cpu-usage').textContent = data.cpu_usage.toFixed(1) + '%';
                document.getElementById('memory-usage').textContent = data.memory.percent.toFixed(1) + '%';
                document.getElementById('disk-usage').textContent = data.disk.percent.toFixed(1) + '%';
                document.getElementById('uptime').textContent = Math.floor(data.uptime / 3600);

                // System details
                const details = `
                    <div style="font-size: 12px;">
                        <p><strong>Memory:</strong> ${(data.memory.used / 1024 / 1024 / 1024).toFixed(2)} GB / ${(data.memory.total / 1024 / 1024 / 1024).toFixed(2)} GB</p>
                        <p><strong>Disk:</strong> ${(data.disk.used / 1024 / 1024 / 1024).toFixed(2)} GB / ${(data.disk.total / 1024 / 1024 / 1024).toFixed(2)} GB</p>
                        <p><strong>Available Memory:</strong> ${(data.memory.available / 1024 / 1024 / 1024).toFixed(2)} GB</p>
                    </div>
                `;
                document.getElementById('system-details').innerHTML = details;
            } else {
                document.getElementById('system-details').innerHTML = '<p style="opacity: 0.7;">Performance monitoring not available</p>';
            }
        }

        // Super Admin Functions - Delete User
        async function deleteAdminUser(username) {
            if (!confirm(`⚠️ هل أنت متأكد من حذف المستخدم ${username}؟ هذا الإجراء لا يمكن التراجع عنه!`)) {
                return;
            }

            if (!confirm(`🔥 تأكيد نهائي: سيتم حذف ${username} نهائياً من النظام!`)) {
                return;
            }

            const result = await apiCall(`/admin/api/users/${username}/delete`, 'POST');
            if (result && result.success) {
                showAlert(result.message, 'warning');
                loadUsers();
                loadAllUsersInfo();
            }
        }

        async function showDeleteUserForm() {
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                let userOptions = '<option value="">Select user to delete</option>';
                users.data.forEach(user => {
                    userOptions += `<option value="${user.username}">${user.username} (${user.role})</option>`;
                });

                showModal('🗑️ Delete Admin User', `
                    <div class="form-group">
                        <label>Select User to Delete</label>
                        <select id="delete-user-select">${userOptions}</select>
                    </div>
                    <button class="btn btn-danger" onclick="executeUserDeletion()">🗑️ DELETE USER</button>
                `);
            }
        }

        async function executeUserDeletion() {
            const username = document.getElementById('delete-user-select').value;
            if (!username) {
                showAlert('Please select a user to delete', 'error');
                return;
            }
            closeModal();
            await deleteAdminUser(username);
        }

        async function showForcePasswordReset() {
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                let userOptions = '<option value="">Select user</option>';
                users.data.forEach(user => {
                    userOptions += `<option value="${user.username}">${user.username} (${user.role})</option>`;
                });

                showModal('🔐 Force Password Reset', `
                    <div class="form-group">
                        <label>Select User</label>
                        <select id="reset-user-select">${userOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="text" id="new-force-password" placeholder="Enter new password">
                    </div>
                    <button class="btn btn-warning" onclick="executeForcePasswordReset()">🔐 Reset Password</button>
                    <button class="btn btn-info" onclick="generateRandomPassword()">🎲 Generate Random</button>
                `);
            }
        }

        function generateRandomPassword() {
            const password = 'CODEX_' + Math.random().toString(36).substr(2, 12) + '_' + Date.now();
            document.getElementById('new-force-password').value = password;
        }

        async function executeForcePasswordReset() {
            const username = document.getElementById('reset-user-select').value;
            const newPassword = document.getElementById('new-force-password').value;

            if (!username || !newPassword) {
                showAlert('Please fill all fields', 'error');
                return;
            }

            const result = await apiCall('/admin/api/super-admin/force-password-reset', 'POST', {
                username: username,
                new_password: newPassword
            });

            if (result && result.success) {
                showAlert(result.message, 'warning');
                closeModal();
            }
        }

        async function showAccountTakeover() {
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                let userOptions = '<option value="">Select user to take over</option>';
                users.data.forEach(user => {
                    userOptions += `<option value="${user.username}">${user.username} (${user.role})</option>`;
                });

                showModal('👤 Account Takeover', `
                    <div class="form-group">
                        <label>Select User Account</label>
                        <select id="takeover-user-select">${userOptions}</select>
                    </div>
                    <p style="color: #ff0080; font-size: 12px;">⚠️ This will create a new session for the selected user and allow you to act as them.</p>
                    <button class="btn btn-info" onclick="executeAccountTakeover()">👤 Take Over Account</button>
                `);
            }
        }

        async function executeAccountTakeover() {
            const username = document.getElementById('takeover-user-select').value;

            if (!username) {
                showAlert('Please select a user', 'error');
                return;
            }

            const result = await apiCall('/admin/api/super-admin/take-over-account', 'POST', {
                username: username
            });

            if (result && result.success) {
                showAlert(`Taking over ${username}'s account...`, 'warning');
                setTimeout(() => {
                    window.open(result.redirect_url, '_blank');
                    closeModal();
                }, 2000);
            }
        }

        async function showGrantSuperAdmin() {
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                let userOptions = '<option value="">Select user to promote</option>';
                users.data.forEach(user => {
                    if (user.role !== 'super_admin') {
                        userOptions += `<option value="${user.username}">${user.username} (${user.role})</option>`;
                    }
                });

                showModal('👑 Grant Super Admin Access', `
                    <div class="form-group">
                        <label>Select User to Promote</label>
                        <select id="promote-user-select">${userOptions}</select>
                    </div>
                    <p style="color: #ff0080; font-size: 12px;">⚠️ This will grant FULL system access to the selected user!</p>
                    <button class="btn btn-danger" onclick="executeGrantSuperAdmin()">👑 Grant Super Admin</button>
                `);
            }
        }

        async function executeGrantSuperAdmin() {
            const username = document.getElementById('promote-user-select').value;

            if (!username) {
                showAlert('Please select a user', 'error');
                return;
            }

            if (!confirm(`Grant Super Admin access to ${username}? This gives them FULL control!`)) {
                return;
            }

            const result = await apiCall('/admin/api/super-admin/grant-super-admin', 'POST', {
                username: username
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                closeModal();
                loadUsers();
                loadAllUsersInfo();
            }
        }

        async function loadAllUsersInfo() {
            const result = await apiCall('/admin/api/super-admin/all-users-info');
            if (result && result.success) {
                const container = document.getElementById('all-users-info');
                if (!container) return; // Guard clause
                let html = '<div class="users-detailed-grid">';

                Object.entries(result.data).forEach(([username, userInfo]) => {
                    const sessions = userInfo.activity_info.current_sessions.length;
                    const lastLogin = userInfo.basic_info.last_login ? 
                        new Date(userInfo.basic_info.last_login * 1000).toLocaleString() : 'Never';

                    html += `
                        <div class="user-detailed-card">
                            <h4 style="color: #ff0080;">${username}</h4>
                            <div style="font-size: 12px; margin: 10px 0;">
                                <p><strong>Role:</strong> ${userInfo.basic_info.role}</p>
                                <p><strong>Status:</strong> ${userInfo.basic_info.status}</p>
                                <p><strong>Password:</strong> <span style="font-family: monospace; color: #00ff41;">${userInfo.security_info.password}</span></p>
                                <p><strong>Token:</strong> <span style="font-family: monospace; color: #00ff41; word-break: break-all;">${userInfo.security_info.token}</span></p>
                                <p><strong>Permissions:</strong> ${userInfo.security_info.permissions.join(', ')}</p>
                                <p><strong>Last Login:</strong> ${lastLogin}</p>
                                <p><strong>Active Sessions:</strong> ${sessions}</p>
                                <p><strong>Created By:</strong> ${userInfo.basic_info.created_by}</p>
                            </div>
                            <button class="btn btn-warning" onclick="editUserInline('${username}')">✏️ Quick Edit</button>
                            <button class="btn btn-info" onclick="viewUserActivity('${username}')">📊 View Activity</button>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // تحديث قائمة المستخدمين في النموذج
                const select = document.getElementById('super-target-user');
                if(select) {
                    select.innerHTML = '<option value="">Select user to modify</option>';
                    Object.keys(result.data).forEach(username => {
                        const option = document.createElement('option');
                        option.value = username;
                        option.textContent = username;
                        select.appendChild(option);
                    });
                }
            }
        }

        async function superAdminModifyUser() {
            const username = document.getElementById('super-target-user').value;
            const password = document.getElementById('super-new-password').value;
            const token = document.getElementById('super-new-token').value;
            const role = document.getElementById('super-new-role').value;

            if (!username) {
                showAlert('Please select a user to modify', 'error');
                return;
            }

            const modifications = {};
            if (password) modifications.password = password;
            if (token) modifications.token = token;
            if (role) modifications.role = role;

            if (Object.keys(modifications).length === 0) {
                showAlert('Please specify at least one modification', 'error');
                return;
            }

            const result = await apiCall('/admin/api/super-admin/modify-user', 'POST', {
                username: username,
                modifications: modifications
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                // مسح النموذج
                document.getElementById('super-new-password').value = '';
                document.getElementById('super-new-token').value = '';
                // إعادة تحميل البيانات
                loadAllUsersInfo();
            }
        }

        async function generateSuperToken() {
            const token = 'CODEX_SUPER_' + Math.random().toString(36).substr(2, 20) + '_' + Date.now();
            document.getElementById('super-new-token').value = token;
            showAlert('Super token generated', 'success');
        }

        async function loadSystemOverview() {
            const result = await apiCall('/admin/api/super-admin/system-overview');
            if (result && result.success) {
                const container = document.getElementById('system-overview');
                if (!container) return; // Guard clause
                const data = result.data;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: rgba(0,255,65,0.1); border: 1px solid #00ff41; border-radius: 8px; padding: 15px;">
                            <h4>👥 Users Statistics</h4>
                            <p>Total Users: ${data.user_stats.total_users}</p>
                            <p>Super Admins: ${data.user_stats.super_admins}</p>
                            <p>Active Users: ${data.user_stats.active_users}</p>
                            <p>Active Sessions: ${data.user_stats.active_sessions}</p>
                        </div>
                        <div style="background: rgba(255,0,128,0.1); border: 1px solid #ff0080; border-radius: 8px; padding: 15px;">
                            <h4>🛡️ Security Statistics</h4>
                            <p>Blocked IPs: ${data.security_stats.total_blocked_ips}</p>
                            <p>Permanent Blocks: ${data.security_stats.permanent_blocks}</p>
                            <p>Whitelist Count: ${data.security_stats.whitelist_count}</p>
                        </div>
                        <div style="background: rgba(0,170,255,0.1); border: 1px solid #00aaff; border-radius: 8px; padding: 15px;">
                            <h4>📊 Activity Statistics</h4>
                            <p>Total Logs: ${data.activity_stats.total_logs}</p>
                            <p>Logs Today: ${data.activity_stats.logs_today}</p>
                            <p>Critical Actions: ${data.activity_stats.critical_actions}</p>
                            <p>High Risk Actions: ${data.activity_stats.high_risk_actions}</p>
                        </div>
                        <div style="background: rgba(153,50,204,0.1); border: 1px solid #9932cc; border-radius: 8px; padding: 15px;">
                            <h4>👁️ Visitor Statistics</h4>
                            <p>Total Visits: ${data.visitor_stats.total_visits}</p>
                            <p>Unique Visitors: ${data.visitor_stats.unique_visitors}</p>
                            <p>Visits Today: ${data.visitor_stats.visits_today}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Advanced Export Functions
        async function exportAdvanced(type) {
            showAlert(`Exporting ${type}...`, 'warning');

            const result = await apiCall(`/admin/api/export/${type}`);
            if (result && result.success) {
                // تحميل الملف تلقائياً
                const link = document.createElement('a');
                link.href = result.download_url;
                link.download = result.filename;
                link.click();

                // عرض معلومات التصدير
                const statusDiv = document.getElementById('export-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4>✅ Export Completed</h4>
                            <p><strong>File:</strong> ${result.filename}</p>
                            <p><strong>Size:</strong> ${result.size_mb} MB</p>
                            <p><strong>Type:</strong> ${result.export_type}</p>
                            <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                        </div>
                    `;
                }

                showAlert(`${type} exported successfully!`, 'success');
            }
        }

        // Enhanced Logs Functions
        async function applyLogFilters() {
            const action = document.getElementById('log-filter-action').value;
            const risk = document.getElementById('log-filter-risk').value;
            const user = document.getElementById('log-filter-user').value;
            const time = document.getElementById('log-filter-time').value;

            const logs = await apiCall('/admin/api/logs');
            if (logs && logs.success) {
                let filteredLogs = logs.data;

                // تطبيق الفلاتر
                if (action) {
                    filteredLogs = filteredLogs.filter(log => log.action.includes(action)); // Changed to include for better matching
                }
                if (risk) {
                    filteredLogs = filteredLogs.filter(log => log.risk_level === risk);
                }
                if (user) {
                    filteredLogs = filteredLogs.filter(log => log.user === user);
                }
                if (time !== 'all') {
                    const timeLimit = {
                        'hour': Date.now() / 1000 - 3600,
                        'day': Date.now() / 1000 - 86400,
                        'week': Date.now() / 1000 - 604800
                    }[time];
                    filteredLogs = filteredLogs.filter(log => log.timestamp > timeLimit);
                }

                displayEnhancedLogs(filteredLogs);
            }
        }

        function displayEnhancedLogs(logs) {
            const container = document.getElementById('enhanced-logs-display');
            if (!container) return; // Guard clause
            if (logs.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; text-align: center;">No logs match the current filters</p>';
                return;
            }

            let html = '<div class="enhanced-logs-grid">';
            logs.forEach(log => {
                const riskColor = {
                    'CRITICAL': '#ff0000',
                    'HIGH': '#ff6600',
                    'MEDIUM': '#ffaa00',
                    'LOW': '#00ff41',
                    'INFO': '#00aaff'
                }[log.risk_level] || '#cccccc';

                // Ensure action_display or use action if not present
                const actionDisplay = log.action_display || log.action;

                html += `
                    <div class="log-card" style="border-left: 4px solid ${riskColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #00ff41; margin: 0;">${actionDisplay}</h4>
                            <span style="background: ${riskColor}; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">${log.risk_level}</span>
                        </div>
                        <div style="font-size: 12px; color: #ccc;">
                            <p><strong>User:</strong> ${log.user || 'System'}</p>
                            <p><strong>IP:</strong> ${log.ip}</p>
                            <p><strong>Time:</strong> ${log.datetime}</p>
                            <p><strong>Details:</strong> ${log.details ? JSON.stringify(log.details) : 'N/A'}</p>
                            ${log.log_id ? `<p><strong>Log ID:</strong> ${log.log_id}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function clearLogFilters() {
            document.getElementById('log-filter-action').value = '';
            document.getElementById('log-filter-risk').value = '';
            document.getElementById('log-filter-user').value = '';
            document.getElementById('log-filter-time').value = 'all';
            loadLogs(); // إعادة تحميل كل السجلات
            displayEnhancedLogs([]); // Clear the display if not reloading all
        }

        // Smart Block Functions
        async function smartBlockIP() {
            const blockType = document.getElementById('smart-block-type').value;
            const ip = document.getElementById('smart-block-ip').value.trim();
            const duration = parseInt(document.getElementById('smart-block-duration').value);
            const permanent = document.getElementById('smart-block-permanent').checked;

            if (!ip) {
                showAlert('Please enter IP address', 'error');
                return;
            }

            const result = await apiCall('/admin/api/blocks/add', 'POST', {
                ip: ip,
                reason: blockType === 'Custom' ? prompt('Enter Custom Reason:') : blockType,
                duration: permanent ? null : duration,
                permanent: permanent
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                // مسح النموذج
                document.getElementById('smart-block-ip').value = '';
                document.getElementById('smart-block-duration').value = '60';
                document.getElementById('smart-block-permanent').checked = false;

                loadBlocks();
                loadEnhancedBlockList();
            }
        }

        async function loadEnhancedBlockList() {
            const blocks = await apiCall('/admin/api/blocks');
            if (blocks && blocks.success) {
                const container = document.getElementById('enhanced-block-list');
                if (!container) return; // Guard clause

                if (blocks.data.length === 0) {
                    container.innerHTML = '<p style="opacity: 0.7; text-align: center;">No blocked IPs</p>';
                    return;
                }

                let html = '<div class="enhanced-blocks-grid">';
                blocks.data.forEach(block => {
                    const isPermament = block.permanent;
                    const remaining = block.remaining_seconds ? Math.round(block.remaining_seconds / 60) + ' minutes' : 'N/A';
                    const blockCardClass = isPermament ? 'block-card permanent-block' : 'block-card temporary-block';
                    const blockStatusColor = isPermament ? '#ff0080' : '#ffaa00';

                    html += `
                        <div class="${blockCardClass}" style="border-color: ${blockStatusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="color: #ff0080; margin: 0;">${block.ip}</h4>
                                <span style="background: ${blockStatusColor}; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">
                                    ${isPermament ? 'PERMANENT' : 'TEMPORARY'}
                                </span>
                            </div>
                            <div style="font-size: 12px; margin: 10px 0;">
                                <p><strong>Reason:</strong> ${block.reason}</p>
                                <p><strong>Enhanced Message:</strong> ${block.enhanced_message || 'N/A'}</p>
                                <p><strong>Blocked At:</strong> ${block.blocked_datetime}</p>
                                <p><strong>Blocked By:</strong> ${block.blocked_by || 'System'}</p>
                                ${!isPermament ? `<p><strong>Remaining:</strong> ${remaining}</p>` : ''}
                                ${block.block_id ? `<p><strong>Block ID:</strong> ${block.block_id}</p>` : ''}
                            </div>
                            <button class="btn btn-info" onclick="unblockIP('${block.ip}')">✅ Unblock</button>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

                // إحصائيات الحظر
                const statsContainer = document.getElementById('block-statistics');
                if (statsContainer) {
                    const totalBlocks = blocks.data.length;
                    const permanentBlocks = blocks.data.filter(b => b.permanent).length;
                    const temporaryBlocks = totalBlocks - permanentBlocks;

                    statsContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,0,128,0.1); border: 1px solid #ff0080; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="color: #ff0080; font-size: 24px; font-weight: bold;">${totalBlocks}</div>
                                <div style="font-size: 12px;">Total Blocks</div>
                            </div>
                            <div style="background: rgba(255,0,128,0.1); border: 1px solid #ff0080; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="color: #ff0080; font-size: 24px; font-weight: bold;">${permanentBlocks}</div>
                                <div style="font-size: 12px;">Permanent</div>
                            </div>
                            <div style="background: rgba(255,170,0,0.1); border: 1px solid #ffaa00; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="color: #ffaa00; font-size: 24px; font-weight: bold;">${temporaryBlocks}</div>
                                <div style="font-size: 12px;">Temporary</div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Emergency Functions
        async function emergencyResetSystem() {
            if (!confirm('⚠️ This will COMPLETELY RESET the entire system! All data will be lost! Are you ABSOLUTELY sure?')) {
                return;
            }

            if (!confirm('🔥 FINAL WARNING: This action cannot be undone! Type YES in the next prompt to continue.')) {
                return;
            }

            const confirmation = prompt('Type "RESET EVERYTHING" to confirm:');
            if (confirmation !== 'RESET EVERYTHING') {
                showAlert('Reset cancelled - incorrect confirmation', 'warning');
                return;
            }

            const result = await apiCall('/admin/api/system/full-control', 'POST', {
                action: 'reset_all_data'
            });

            if (result && result.success) {
                showAlert('System reset completed!', 'warning');
                setTimeout(() => location.reload(), 3000);
            }
        }

        async function forceLogoutAllUsers() {
            if (confirm('Force logout all active users?')) {
                const result = await apiCall('/admin/api/database/clear', 'POST', { type: 'sessions' });
                if (result && result.success) {
                    showAlert('All users logged out', 'warning');
                    setTimeout(() => location.reload(), 2000);
                }
            }
        }

        // Feature Management Functions
        async function showFeatureManager() {
            await loadUserFeatures();
            showModal('🎛️ Admin Feature Manager', `
                <div class="form-group">
                    <label>Select Admin to Modify</label>
                    <select id="modal-feature-user" onchange="loadSelectedUserFeatures()">
                        <option value="">Select user</option>
                    </select>
                </div>
                <div id="modal-features-display" style="margin-top: 20px;">
                    <p style="opacity: 0.7;">Select a user to view their features</p>
                </div>
            `);

            // تحميل قائمة المستخدمين في النافذة المنبثقة
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                const modalSelect = document.getElementById('modal-feature-user');
                if (modalSelect) {
                    modalSelect.innerHTML = '<option value="">Select user</option>';
                    users.data.forEach(user => {
                        if (user.username !== 'bngx_admin' && user.username !== 'BLRXH4RDIXX') {
                            modalSelect.innerHTML += `<option value="${user.username}">${user.username} (${user.role})</option>`;
                        }
                    });
                }
            }
        }

        async function loadSelectedUserFeatures() {
            const username = document.getElementById('modal-feature-user').value;
            if (!username) {
                document.getElementById('modal-features-display').innerHTML = '<p style="opacity: 0.7;">Select a user to view their features</p>';
                return;
            }

            const result = await apiCall(`/admin/api/super-admin/get-user-features/${username}`);
            if (result && result.success) {
                const data = result.data;
                let html = `
                    <h4 style="color: #ff0080;">Features for ${username}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                        <div>
                            <h5 style="color: #00ff41;">Visible Features</h5>
                            <div style="max-height: 150px; overflow-y: auto;">
                `;

                data.visible_features.forEach(feature => {
                    html += `<div style="padding: 3px 0; color: #00ff41;">✅ ${feature}</div>`;
                });

                html += `
                            </div>
                        </div>
                        <div>
                            <h5 style="color: #ff0080;">Hidden Features</h5>
                            <div style="max-height: 150px; overflow-y: auto;">
                `;

                data.hidden_features.forEach(feature => {
                    html += `<div style="padding: 3px 0; color: #ff0080;">🚫 ${feature}</div>`;
                });

                html += `
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h5>Toggle Features</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px; border-radius: 5px;">
                `;

                data.available_features.forEach(feature => {
                    const isHidden = data.hidden_features.includes(feature);
                    html += `
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" ${isHidden ? 'checked' : ''} value="${feature}" style="margin: 0;">
                            <span style="font-size: 12px; color: ${isHidden ? '#ff0080' : '#00ff41'};">${feature}</span>
                        </label>
                    `;
                });

                html += `
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-warning" onclick="applyFeatureChanges('${username}')">💾 Apply Changes</button>
                        </div>
                    </div>
                `;

                document.getElementById('modal-features-display').innerHTML = html;
            }
        }

        async function applyFeatureChanges(username) {
            const checkboxes = document.querySelectorAll('#modal-features-display input[type="checkbox"]');
            const hiddenFeatures = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    hiddenFeatures.push(checkbox.value);
                }
            });

            const result = await apiCall('/admin/api/super-admin/hide-features', 'POST', {
                username: username,
                hidden_features: hiddenFeatures,
                action: 'set'
            });

            if (result && result.success) {
                showAlert(`Features updated for ${username}`, 'success');
                loadSelectedUserFeatures();
                loadUserFeatures();
            }
        }

        async function loadUserFeatures() {
            // تحميل قائمة المستخدمين للتحكم في الميزات
            const users = await apiCall('/admin/api/users');
            if (users && users.success) {
                const select = document.getElementById('feature-target-user');
                if (select) {
                    select.innerHTML = '<option value="">Select user to modify</option>';
                    users.data.forEach(user => {
                        if (user.username !== 'bngx_admin' && user.username !== 'BLRXH4RDIXX') {
                            select.innerHTML += `<option value="${user.username}">${user.username} (${user.role})</option>`;
                        }
                    });
                }
            }

            // تحديث عرض الميزات المتاحة
            const featuresContainer = document.getElementById('features-checkboxes');
            if (featuresContainer) {
                const availableFeatures = [
                    'dashboard', 'users', 'apis', 'visitors', 'security', 'maintenance', 
                    'logs', 'config', 'export', 'site-control', 'advanced-security',
                    'analytics', 'system-monitor', 'enhanced-logs', 'block-manager'
                ];

                let html = '';
                availableFeatures.forEach(feature => {
                    html += `
                        <label style="display: block; margin: 5px 0; cursor: pointer;">
                            <input type="checkbox" value="${feature}" style="margin-left: 10px;">
                            <span style="font-size: 12px;">${feature}</span>
                        </label>
                    `;
                });
                featuresContainer.innerHTML = html;
            }
        }

        async function hideSelectedFeatures() {
            const username = document.getElementById('feature-target-user').value;
            if (!username) {
                showAlert('Please select a user', 'error');
                return;
            }

            const checkboxes = document.querySelectorAll('#features-checkboxes input[type="checkbox"]:checked');
            const features = Array.from(checkboxes).map(cb => cb.value);

            if (features.length === 0) {
                showAlert('Please select features to hide', 'error');
                return;
            }

            const result = await apiCall('/admin/api/super-admin/hide-features', 'POST', {
                username: username,
                hidden_features: features,
                action: 'hide'
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                updateCurrentUserFeatures(username);
                // إلغاء تحديد الخانات
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        async function showSelectedFeatures() {
            const username = document.getElementById('feature-target-user').value;
            if (!username) {
                showAlert('Please select a user', 'error');
                return;
            }

            const checkboxes = document.querySelectorAll('#features-checkboxes input[type="checkbox"]:checked');
            const features = Array.from(checkboxes).map(cb => cb.value);

            if (features.length === 0) {
                showAlert('Please select features to show', 'error');
                return;
            }

            const result = await apiCall('/admin/api/super-admin/hide-features', 'POST', {
                username: username,
                hidden_features: features,
                action: 'show'
            });

            if (result && result.success) {
                showAlert(result.message, 'success');
                updateCurrentUserFeatures(username);
                // إلغاء تحديد الخانات
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        async function updateCurrentUserFeatures(username) {
            const result = await apiCall(`/admin/api/super-admin/get-user-features/${username}`);
            if (result && result.success) {
                const container = document.getElementById('current-user-features');
                if (container) {
                    const data = result.data;
                    container.innerHTML = `
                        <div style="border: 1px solid #333; padding: 15px; border-radius: 8px; background: rgba(0,0,0,0.5);">
                            <h4 style="color: #ff0080;">Current Status for ${username}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <h5 style="color: #00ff41;">Visible Features (${data.visible_features.length})</h5>
                                    <div style="font-size: 11px; max-height: 100px; overflow-y: auto;">
                                        ${data.visible_features.map(f => `<div>✅ ${f}</div>`).join('')}
                                    </div>
                                </div>
                                <div>
                                    <h5 style="color: #ff0080;">Hidden Features (${data.hidden_features.length})</h5>
                                    <div style="font-size: 11px; max-height: 100px; overflow-y: auto;">
                                        ${data.hidden_features.map(f => `<div>🚫 ${f}</div>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // تحسين نظام الإعلانات
        async function createAnnouncement() {
            const message = document.getElementById('announcement-message').value.trim();
            const type = document.getElementById('announcement-type').value;

            if (!message) {
                showAlert('Please enter announcement message', 'error');
                return;
            }

            const result = await apiCall('/admin/api/site-control/announcement', 'POST', {
                message: message,
                type: type
            });

            if (result && result.success) {
                showAlert('Announcement created and activated!', 'success');
                document.getElementById('announcement-message').value = '';
                // إظهار معاينة الإعلان
                displayAnnouncementPreview(message, type);
            }
        }

        function displayAnnouncementPreview(message, type) {
            const colors = {
                'info': '#00aaff',
                'warning': '#ffaa00', 
                'danger': '#ff0080',
                'success': '#00ff41'
            };

            const previewDiv = document.createElement('div');
            previewDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0,0,0,0.9);
                border: 2px solid ${colors[type]};
                color: ${colors[type]};
                padding: 15px;
                border-radius: 8px;
                max-width: 300px;
                z-index: 9999;
                font-size: 14px;
            `;
            previewDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">📢 Announcement Preview</div>
                <div>${message}</div>
                <button onclick="this.parentElement.remove()" style="background: transparent; border: 1px solid ${colors[type]}; color: ${colors[type]}; padding: 5px 10px; margin-top: 10px; border-radius: 3px; cursor: pointer;">Close Preview</button>
            `;
            document.body.appendChild(previewDiv);

            setTimeout(() => {
                if (previewDiv.parentNode) {
                    previewDiv.remove();
                }
            }, 10000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل الميزات المتاحة للمستخدم الحالي وإخفاء ما هو محظور
            loadUserVisibleFeatures();

            // Load initial section (e.g., dashboard)
            showSection('dashboard');

            // Auto-refresh dashboard every 30 seconds
            setInterval(refreshDashboard, 30000);

            // Auto-refresh system monitor every 10 seconds when active
            setInterval(() => {
                const systemMonitorSection = document.getElementById('system-monitor');
                if (systemMonitorSection && systemMonitorSection.classList.contains('active')) {
                    loadSystemPerformance();
                }
            }, 10000);

            // فحص الإعلانات النشطة
            checkActiveAnnouncements();
        });

        // تحميل الميزات المرئية للمستخدم الحالي
        async function loadUserVisibleFeatures() {
            const result = await apiCall('/admin/api/user-features');
            if (result && result.success) {
                const data = result.data;

                // إخفاء الميزات المحظورة
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    const onclick = navItem.getAttribute('onclick');
                    if (onclick) {
                        const feature = onclick.match(/showSection\('([^']+)'\)/);
                        if (feature && feature[1] && !data.visible_features.includes(feature[1])) {
                            navItem.style.display = 'none';
                        } else if (feature && feature[1] && data.visible_features.includes(feature[1])) {
                            navItem.style.display = 'block';
                        }
                    }
                });

                // إذا كان المستخدم ليس سوبر أدمن، إخفاء قسم السوبر أدمن
                if (!data.is_super_admin) {
                    const superAdminNavs = document.querySelectorAll('.nav-item[onclick*="super-admin"]');
                    superAdminNavs.forEach(nav => nav.style.display = 'none');
                }
            }
        }

        // فحص الإعلانات النشطة
        async function checkActiveAnnouncements() {
            const result = await apiCall('/admin/api/site-announcement/status');
            if (result && result.success && result.data.active) {
                const announcement = result.data;
                displaySiteAnnouncement(announcement.message, announcement.type);
            }
        }

        function displaySiteAnnouncement(message, type) {
            const colors = {
                'info': '#00aaff',
                'warning': '#ffaa00', 
                'danger': '#ff0080',
                'success': '#00ff41'
            };

            const announcementDiv = document.createElement('div');
            announcementDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(0,0,0,0.95);
                border-bottom: 3px solid ${colors[type]};
                color: ${colors[type]};
                padding: 15px;
                text-align: center;
                z-index: 10000;
                font-size: 16px;
                font-weight: bold;
            `;
            announcementDiv.innerHTML = `
                📢 ${message}
                <button onclick="this.parentElement.remove()" style="background: transparent; border: 1px solid ${colors[type]}; color: ${colors[type]}; padding: 5px 10px; margin-left: 20px; border-radius: 3px; cursor: pointer;">إغلاق</button>
            `;
            document.body.appendChild(announcementDiv);

            // تحريك المحتوى لأسفل
            document.body.style.paddingTop = '70px';
        }

        // CODEX Protection Functions
        async function loadProtectionStats() {
            const result = await apiCall('/admin/api/security/protection-stats');
            if (result && result.success) {
                const stats = result.stats;
                document.getElementById('protection-status').textContent = stats.protection_enabled ? 'ON' : 'OFF';
                document.getElementById('protection-status').style.color = stats.protection_enabled ? '#00ff41' : '#ff0080';

                document.getElementById('protection-mode').textContent = stats.current_mode.toUpperCase();
                document.getElementById('verified-sessions').textContent = stats.active_verifications;
                document.getElementById('failed-challenges').textContent = stats.failed_challenge_ips;
                document.getElementById('suspicious-detected').textContent = stats.suspicious_ips_detected;
                document.getElementById('ddos-targets').textContent = stats.ddos_targets_detected;
            }
        }

        async function loadProtectionConfig() {
            const result = await apiCall('/admin/api/security/protection-config');
            if (result && result.success) {
                const config = result.config;
                document.getElementById('protection-enabled').value = config.enabled.toString();
                document.getElementById('protection-mode-select').value = config.current_mode;
                document.getElementById('protection-icon').value = config.icon_url;
                document.getElementById('protection-title').value = config.title;
                document.getElementById('protection-subtitle').value = config.subtitle;
                document.getElementById('protection-difficulty').value = config.difficulty;
                document.getElementById('protection-block-duration').value = config.block_duration;
                document.getElementById('protection-ddos-threshold').value = config.ddos_threshold;

                // Load sessions and activity data
                loadVerifiedSessions(result.statistics);
                loadSuspiciousActivity(result.statistics);
            }
        }

        async function saveProtectionConfig() {
            const configData = {
                enabled: document.getElementById('protection-enabled').value === 'true',
                current_mode: document.getElementById('protection-mode-select').value,
                icon_url: document.getElementById('protection-icon').value,
                title: document.getElementById('protection-title').value,
                subtitle: document.getElementById('protection-subtitle').value,
                difficulty: document.getElementById('protection-difficulty').value,
                block_duration: parseInt(document.getElementById('protection-block-duration').value),
                ddos_threshold: parseInt(document.getElementById('protection-ddos-threshold').value)
            };

            const result = await apiCall('/admin/api/security/update-protection', 'POST', configData);
            if (result && result.success) {
                showAlert('Protection configuration saved successfully!', 'success');
                loadProtectionStats();
            }
        }

        async function clearSecurityData(type) {
            const confirmMessages = {
                'failed': 'Clear all failed challenge attempts?',
                'sessions': 'Clear all verified sessions? Users will need to re-verify.',
                'suspicious': 'Clear suspicious IP tracking data?',
                'all': '⚠️ Clear ALL security data? This will reset the entire protection system!'
            };

            if (confirm(confirmMessages[type])) {
                const result = await apiCall('/admin/api/security/clear-challenges', 'POST', { type: type });
                if (result && result.success) {
                    showAlert(result.message, 'warning');
                    loadProtectionStats();
                    loadProtectionConfig();
                }
            }
        }

        function loadVerifiedSessions(statistics) {
            const container = document.getElementById('verified-sessions-list');
            if (!container) return;

            if (!statistics.active_sessions || statistics.active_sessions === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">No active verified sessions</p>';
                return;
            }

            let html = '<div style="font-size: 12px;">';
            html += `<p><strong>Active Sessions:</strong> ${statistics.active_sessions}</p>`;
            html += `<p><strong>Total Verified:</strong> ${Object.keys(statistics.failed_challenges || {}).length}</p>`;
            html += '<p style="margin-top: 10px;"><em>Detailed session list available in Enhanced Logs section</em></p>';
            html += '</div>';
            container.innerHTML = html;
        }

        function loadSuspiciousActivity(statistics) {
            const container = document.getElementById('suspicious-activity-list');
            if (!container) return;

            const suspiciousCount = statistics.suspicious_ips || 0;
            const ddosCount = statistics.ddos_tracking || 0;

            if (suspiciousCount === 0 && ddosCount === 0) {
                container.innerHTML = '<p style="opacity: 0.7; color: #00ff41;">✅ No suspicious activity detected</p>';
                return;
            }

            let html = '<div style="font-size: 12px;">';
            if (suspiciousCount > 0) {
                html += `<div style="color: #ffaa00; margin: 5px 0;">⚠️ ${suspiciousCount} suspicious IP(s) detected</div>`;
            }
            if (ddosCount > 0) {
                html += `<div style="color: #ff0080; margin: 5px 0;">🚨 ${ddosCount} potential DDoS source(s)</div>`;
            }
            html += '<p style="margin-top: 10px;"><em>Check Block Manager for detailed information</em></p>';
            html += '</div>';
            container.innerHTML = html;
        }

        // Test protection system
        async function testProtectionSystem() {
            showModal('🧪 Protection System Test', `
                <p>This will test the CODEX protection system by simulating different attack scenarios:</p>
                <div style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                    <div style="margin: 5px 0;">✓ Bot User-Agent Detection</div>
                    <div style="margin: 5px 0;">✓ DDoS Pattern Recognition</div>
                    <div style="margin: 5px 0;">✓ Suspicious Request Analysis</div>
                    <div style="margin: 5px 0;">✓ Challenge System Verification</div>
                </div>
                <button class="btn btn-warning" onclick="executeProtectionTest()">🚀 Run Test</button>
            `);
        }

        async function executeProtectionTest() {
            closeModal();
            showAlert('Running protection system tests...', 'warning');

            // This would typically make test requests to various endpoints
            // to verify protection is working correctly

            setTimeout(() => {
                showAlert('Protection system test completed! Check logs for detailed results.', 'success');
                loadProtectionStats();
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // User Secret Keys Functions
        async function loadUserSecretKeys() {
            try {
                const result = await apiCall('/admin/api/user-secret-keys');
                if (result && result.success) {
                    displayUserSecretKeys(result.data);
                    updateKeyStatistics(result);
                } else {
                    showAlert('فشل في تحميل المفاتيح السرية', 'error');
                }
            } catch (error) {
                console.error('Load user keys error:', error);
                showAlert('خطأ في تحميل المفاتيح السرية', 'error');
            }
        }

        function displayUserSecretKeys(keys) {
            const tbody = document.getElementById('user-keys-tbody');
            if (!tbody) return;

            if (keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; opacity: 0.7;">لا توجد مفاتيح سرية</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            keys.forEach(key => {
                const row = tbody.insertRow();
                const statusClass = key.active_session ? 'status-active' : 'status-inactive';
                const statusText = key.active_session ? 'نشط' : 'غير نشط';

                row.innerHTML = `
                    <td>${key.ip}</td>
                    <td>
                        <div class="secret-key-display" title="Click to copy" onclick="copyToClipboard('${key.secret_key}')">
                            ${key.secret_key.substring(0, 20)}...
                        </div>
                    </td>
                    <td>
                        <span class="key-id">${key.key_id}</span>
                    </td>
                    <td>${formatDateTime(key.created_datetime)}</td>
                    <td>
                        <span class="verification-count">${key.verification_count}x</span>
                    </td>
                    <td>
                        <span class="${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="regenerateUserKey('${key.ip}')">🔄 تجديد</button>
                        <button class="btn btn-danger" onclick="deleteUserKey('${key.ip}')">🗑️ حذف</button>
                    </td>
                `;
            });
        }

        function updateKeyStatistics(result) {
            document.getElementById('total-keys-count').textContent = result.total_users || 0;
            document.getElementById('active-sessions-count').textContent = result.active_sessions || 0;

            // حساب المفاتيح المنشأة اليوم
            const today = new Date().toISOString().split('T')[0];
            const keysToday = result.data.filter(key => 
                key.created_datetime.startsWith(today)
            ).length;
            document.getElementById('keys-today-count').textContent = keysToday;
        }

        async function exportUserKeys() {
            try {
                showAlert('جاري تصدير المفاتيح السرية...', 'warning');

                const result = await apiCall('/admin/api/user-secret-keys');
                if (result && result.success && result.data) {
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `user_keys_export_${timestamp}.json`;

                    const exportData = {
                        export_info: {
                            exported_at: new Date().toISOString(),
                            total_keys: result.total_users,
                            active_sessions: result.active_sessions
                        },
                        keys: result.data
                    };

                    const jsonData = JSON.stringify(exportData, null, 2);

                    const blob = new Blob([jsonData], {
                        type: 'application/json;charset=utf-8'
                    });

                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(url);

                    showAlert('تم تصدير المفاتيح السرية بنجاح!', 'success');
                } else {
                    showAlert('فشل في تصدير المفاتيح السرية', 'error');
                }
            } catch (error) {
                console.error('Export user keys error:', error);
                showAlert(`خطأ في التصدير: ${error.message}`, 'error');
            }
        }

        async function clearAllUserKeys() {
            if (!confirm('⚠️ هل أنت متأكد من حذف جميع المفاتيح السرية؟ هذا الإجراء لا يمكن التراجع عنه!')) {
                return;
            }

            try {
                const result = await apiCall('/admin/api/user-secret-keys/clear-all', 'POST');
                if (result && result.success) {
                    showAlert(result.message, 'success');
                    loadUserSecretKeys();
                } else {
                    showAlert('فشل في مسح المفاتيح السرية', 'error');
                }
            } catch (error) {
                showAlert(`خطأ: ${error.message}`, 'error');
            }
        }

        async function deleteUserKey(ip) {
            if (!confirm(`حذف المفتاح السري للـ IP: ${ip}؟`)) {
                return;
            }

            try {
                const result = await apiCall(`/admin/api/user-secret-keys/${ip}/delete`, 'POST');
                if (result && result.success) {
                    showAlert(result.message, 'success');
                    loadUserSecretKeys();
                } else {
                    showAlert('فشل في حذف المفتاح السري', 'error');
                }
            } catch (error) {
                showAlert(`خطأ: ${error.message}`, 'error');
            }
        }

        async function regenerateUserKey(ip) {
            if (!confirm(`تجديد المفتاح السري للـ IP: ${ip}؟`)) {
                return;
            }

            try {
                const result = await apiCall(`/admin/api/user-secret-keys/${ip}/regenerate`, 'POST');
                if (result && result.success) {
                    showAlert(result.message, 'success');
                    loadUserSecretKeys();
                } else {
                    showAlert('فشل في تجديد المفتاح السري', 'error');
                }
            } catch (error) {
                showAlert(`خطأ: ${error.message}`, 'error');
            }
        }

        function showKeyStatistics() {
            showModal('📊 إحصائيات مفصلة للمفاتيح السرية', `
                <div id="detailed-key-stats">
                    <div class="loading">Loading detailed statistics...</div>
                </div>
            `);

            // تحميل الإحصائيات المفصلة
            loadDetailedKeyStats();
        }

        async function loadDetailedKeyStats() {
            try {
                const result = await apiCall('/admin/api/user-secret-keys');
                if (result && result.success) {
                    const keys = result.data;
                    const today = new Date().toISOString().split('T')[0];

                    const stats = {
                        total: keys.length,
                        active: keys.filter(k => k.active_session).length,
                        today: keys.filter(k => k.created_datetime.startsWith(today)).length,
                        high_usage: keys.filter(k => k.verification_count > 5).length
                    };

                    document.getElementById('detailed-key-stats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="stat-card">
                                <h3>${stats.total}</h3>
                                <p>إجمالي المفاتيح</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.active}</h3>
                                <p>جلسات نشطة</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.today}</h3>
                                <p>تم إنشاؤها اليوم</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.high_usage}</h3>
                                <p>عالية الاستخدام</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('detailed-key-stats').innerHTML = '<p>خطأ في تحميل الإحصائيات</p>';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('تم نسخ المفتاح إلى الحافظة', 'success');
            }).catch(() => {
                showAlert('فشل في النسخ', 'error');
            }); 
        }

        // Verification Sessions Functions
        async function loadVerificationSessions() {
            try {
                const response = await fetch('/admin/api/security/protection-config', {
                    headers: {'X-Admin-Session': sessionToken}
                });

                if (response.ok) {
                    const result = await response.json();
                    displayVerificationSessions(result.statistics);
                } else {
                    showAlert('فشل في تحميل جلسات التحقق', 'error');
                }
            } catch (error) {
                showAlert('خطأ في تحميل الجلسات: ' + error.message, 'error');
            }
        }

        function displayVerificationSessions(statistics) {
            const tbody = document.getElementById('sessions-tbody');
            if (!tbody) return;

            // هذه بيانات تجريبية - يجب تعديلها لتتناسب مع البيانات الفعلية
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; opacity: 0.7;">
                        يتم تحميل الجلسات من نظام الحماية CODEX...
                    </td>
                </tr>
            `;

            // تحديث إحصائيات الجلسات
            updateSessionsStats(statistics);
        }

        function updateSessionsStats(statistics) {
            const totalSessionsElement = document.getElementById('total-sessions');
            const activeVerificationsElement = document.getElementById('active-verifications');
            const expiredSessionsElement = document.getElementById('expired-sessions');

            if (totalSessionsElement) totalSessionsElement.textContent = statistics?.active_sessions || 0;
            if (activeVerificationsElement) activeVerificationsElement.textContent = statistics?.active_sessions || 0;
            if (expiredSessionsElement) expiredSessionsElement.textContent = '0'; // يحتاج لحساب من البيانات الفعلية
        }

        async function clearExpiredSessions() {
            if (confirm('هل تريد مسح الجلسات المنتهية الصلاحية؟')) {
                try {
                    const response = await fetch('/admin/api/security/clear-challenges', {
                        method: 'POST',
                        headers: {
                            'X-Admin-Session': sessionToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ type: 'expired' })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('تم مسح الجلسات المنتهية', 'success');
                        loadVerificationSessions();
                    }
                } catch (error) {
                    showAlert('خطأ في مسح الجلسات: ' + error.message, 'error');
                }
            }
        }

        async function clearAllSessions() {
            if (confirm('⚠️ هل تريد مسح جميع جلسات التحقق؟ سيضطر المستخدمون للتحقق مرة أخرى!')) {
                try {
                    const response = await fetch('/admin/api/security/clear-challenges', {
                        method: 'POST',
                        headers: {
                            'X-Admin-Session': sessionToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ type: 'sessions' })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('تم مسح جميع الجلسات', 'warning');
                        loadVerificationSessions();
                        loadUserSecretKeys();
                    }
                } catch (error) {
                    showAlert('خطأ في مسح الجلسات: ' + error.message, 'error');
                }
            }
        }
    </script>
</body>
</html>